var Comment={editor:void 0,remove:function(e){if(!confirm(Label.confirmRemoveLabel))return!1;$.ajax({url:Label.servePath+"/comment/"+e+"/remove",type:"POST",cache:!1,success:function(t,i){0===t.sc?$("#"+e).remove():alert(t.msg)}})},exchangeCmtSort:function(e){e=0===e?1:0,window.location.href=window.location.pathname+"?m="+e},_bgFade:function(e){return 0!==e.length&&($(window).scrollTop(e[0].offsetTop-48),"comments"!==e.attr("id")&&(e.css({"background-color":"#9bbee0"}),setTimeout(function(){e.css({"background-color":"#FFF",transition:"all 3s cubic-bezier(0.56, -0.36, 0.58, 1)"})},100),void setTimeout(function(){e.removeAttr("style")},3100)))},edit:function(e){Comment._toggleReply(),$(".cmt-anonymous").hide(),$.ajax({url:Label.servePath+"/comment/"+e+"/content",type:"GET",cache:!1,success:function(e,t){0===e.sc&&Comment.editor.setValue(e.commentContent)}}),$("#replyUseName").html('<a href="javascript:void(0)" onclick="Comment._bgFade($(\'#'+e+'\'))" class="ft-a-title"><span class="icon-edit"></span> '+Label.commonUpdateCommentPermissionLabel+"</a>").data("commentId",e)},goComment:function(e){if(0===$(e.substr(e.length-14,14)).length)return window.location=e,!1;$("#comments .list > ul > li").removeAttr("style"),Comment._bgFade($(e.substr(e.length-14,14)))},_setCmtVia:function(){$(".cmt-via").each(function(){var e=$(this).data("ua"),t=Util.getDeviceByUa(e);""!==t&&$(this).html("via "+t)})},_toggleReply:function(e){return Label.isLoggedIn?0===$("#commentContent").length?(alert(Label.notAllowCmtLabel),!1):"false"===$(this).data("hasPermission")?(Article.permissionTip(Label.noPermissionLabel),!1):$(".footer").attr("style")?($(".editor-panel .wrapper").slideUp(function(){$(".editor-panel").hide(),$(".footer").removeAttr("style")}),!1):($(".cmt-anonymous").show(),$(".footer").css("margin-bottom",$(".editor-panel > .wrapper").outerHeight()+"px"),$("#replyUseName").html('<a href="javascript:void(0)" onclick="Comment._bgFade($(\'.article-content\'))" class="ft-a-title"><span class="icon-reply-to"></span>'+$(".article-title").text()+"</a>").removeData(),"0px"!==$(".editor-panel").css("bottom")&&($(".editor-panel .wrapper").hide(),$(".editor-panel").css("bottom",0)),$(".editor-panel").show(),void $(".editor-panel .wrapper").slideDown(function(){Comment.editor.focus(),e&&e()})):(Util.needLogin(),!1)},_initHotKey:function(){if(!Label.userKeyboardShortcutsStatus||"1"===Label.userKeyboardShortcutsStatus)return!1;$(document).bind("keyup","x",function(){return Util.prevKey="x",setTimeout(function(){Util.prevKey=void 0},1e3),!1}).bind("keyup","v",function(){return Util.prevKey="v",setTimeout(function(){Util.prevKey=void 0},1e3),!1}).bind("keydown","r",function(e){return Util.prevKey?"v"===Util.prevKey?$("#articleRewardContent .icon-points").parent().click():1===$("#comments .list > ul > li.focus").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .icon-reply").parent().click():Comment._toggleReply(),!1}).bind("keyup","h",function(){return 1===$("#comments .list > ul > li.focus").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .icon-heart").parent().click(),!1}).bind("keyup","t",function(){return 1===$("#comments .list > ul > li.focus").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .icon-thumbs-up").parent().click(),!1}).bind("keyup","d",function(){return 1===$("#comments .list > ul > li.focus").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .icon-thumbs-down").parent().click(),!1}).bind("keyup","c",function(){return 1===$("#comments .list > ul > li.focus .comment-info .icon-reply-to").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .comment-info .icon-reply-to").parent().click(),!1}).bind("keyup","m",function(){return 1===$("#comments .list > ul > li.focus .comment-action > .ft-fade > .fn-pointer").length&&"x"===Util.prevKey&&$("#comments .list > ul > li.focus .comment-action > .ft-fade > .fn-pointer").click(),!1}).bind("keyup","a",function(){return"x"===Util.prevKey&&1===$("#comments .list > ul > li.focus .icon-setting").parent().length&&(window.location=$("#comments .list > ul > li.focus .icon-setting").parent().attr("href")),!1}).bind("keyup","m",function(){return"v"===Util.prevKey&&Article.toggleToc(),!1}).bind("keyup","h",function(){return"v"===Util.prevKey&&$("#thankArticle").click(),!1}).bind("keyup","t",function(){return"v"===Util.prevKey&&$(".article-header .icon-thumbs-up").parent().click(),!1}).bind("keyup","d",function(){return"v"===Util.prevKey&&$(".article-header .icon-thumbs-down").parent().click(),!1}).bind("keyup","i",function(){return"v"===Util.prevKey&&$(".article-header .icon-view").parent().click(),!1}).bind("keyup","c",function(){return"v"===Util.prevKey&&$(".article-header .icon-star").parent().click(),!1}).bind("keyup","l",function(){return"v"===Util.prevKey&&$(".article-header .icon-history").parent().click(),!1}).bind("keyup","e",function(){return"v"===Util.prevKey&&1===$(".article-actions .icon-edit").parent().length&&(window.location=$(".article-actions .icon-edit").parent().attr("href")),!1}).bind("keyup","s",function(){return"v"===Util.prevKey&&1===$(".article-actions .icon-chevron-up").length&&Article.stick(Label.articleOId),!1}).bind("keyup","a",function(){return"v"===Util.prevKey&&1===$(".article-actions .icon-setting").parent().length&&(window.location=$(".article-actions .icon-setting").parent().attr("href")),!1}).bind("keyup","p",function(){return"v"===Util.prevKey&&1===$(".article-header a[rel=prev]").length&&(window.location=$(".article-header a[rel=prev]").attr("href")),!1}).bind("keyup","n",function(){return"v"===Util.prevKey&&1===$(".article-header a[rel=next]").length&&(window.location=$(".article-header a[rel=next]").attr("href")),!1})},init:function(){if(1===$(window.location.hash).length&&Comment._bgFade($(window.location.hash)),this._setCmtVia(),this._initHotKey(),$.pjax({selector:"#comments .pagination a",container:"#comments",show:"",cache:!1,storage:!0,titleSuffix:""}),NProgress.configure({showSpinner:!1}),$("#comments").bind("pjax.start",function(){NProgress.start()}),$("#comments").bind("pjax.end",function(){NProgress.done()}),!Label.isLoggedIn||!document.getElementById("commentContent"))return!1;Util.initCodeMirror();var e=new Editor({element:document.getElementById("commentContent"),dragDrop:!1,lineWrapping:!0,htmlURL:Label.servePath+"/markdown",toolbar:[{name:"emoji"},{name:"bold"},{name:"italic"},{name:"quote"},{name:"link"},{name:"image",html:'<div class="tooltipped tooltipped-n" aria-label="'+Label.uploadFileLabel+'" ><form id="fileUpload" method="POST" enctype="multipart/form-data"><label class="icon-upload"><input type="file"/></label></form></div>'},{name:"unordered-list"},{name:"ordered-list"},{name:"view"},{name:"fullscreen"},{name:"question",action:"https://hacpai.com/guide/markdown"}],extraKeys:{"Alt-/":"autocompleteUserName","Cmd-/":"autocompleteEmoji","Ctrl-/":"autocompleteEmoji","Alt-S":"startAudioRecord","Alt-R":"endAudioRecord",Esc:function(){$(".editor-hide").click()}},status:!1});if(e.render(),e.codemirror.for="comment",Comment.editor=e.codemirror,window.localStorage&&window.localStorage[Label.articleOId]){var t=null;try{t=JSON.parse(window.localStorage[Label.articleOId])}catch(e){var i={commentContent:""};window.localStorage[Label.articleOId]=JSON.stringify(i),t=JSON.parse(window.localStorage[Label.articleOId])}""!==t.commentContent.replace(/(^\s*)|(\s*$)/g,"")&&Comment.editor.setValue(t.commentContent)}this._initMathJax(),Comment.editor.on("changes",function(e){$("#addCommentTip").removeClass("error succ").html(""),window.localStorage&&(window.localStorage[Label.articleOId]=JSON.stringify({commentContent:e.getValue()}));var t=e.getCursor();return 0===e.getTokenAt(t).string.indexOf("@")?void e.showHint({hint:CodeMirror.hint.userName,completeSingle:!1}):0!==$(".editor-preview-active").length&&void $.ajax({url:Label.servePath+"/markdown",type:"POST",cache:!1,data:{markdownText:e.getValue()},success:function(e,t){$(".article-comment-content .editor-preview-active").html(e.html),hljs.initHighlighting.called=!1,hljs.initHighlighting()}})}),Comment.editor.on("keypress",function(e,t){if(t.ctrlKey&&10===t.charCode)return Comment.add(Label.articleOId,Label.csrfToken),!1}),Comment.editor.on("keydown",function(e,t){if($.ua.set(navigator.userAgent),$.ua.os.name.indexOf("Mac OS")>-1&&t.metaKey&&13===t.keyCode)return Comment.add(Label.articleOId,Label.csrfToken),!1;if(8===t.keyCode){var i=e.getCursor(),n=e.getTokenAt(i),o=CodeMirror.Pos(i.line,i.ch);n=e.getTokenAt(o),/^:\S+:$/.test(n.string)&&e.replaceRange("",CodeMirror.Pos(i.line,n.start),CodeMirror.Pos(i.line,n.end-1))}})},_initMathJax:function(){var e=!1;$(".content-reset").each(function(){$(this).find("p").each(function(){if($(this).text().indexOf("$/")>-1||$(this).text().indexOf("$$")>-1)return e=!0,!1})}),e&&$.ajax({method:"GET",url:"https://cdn.staticfile.org/MathJax/MathJax-2.6-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&_=1473258780393",dataType:"script"}).done(function(){MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]],processEscapes:!0,processEnvironments:!0,skipTags:["pre","code"]}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)1===$(t[e].SourceElement().parentNode).closest(".content-reset")&&(t[e].SourceElement().parentNode.className+="has-jax")})})},thank:function(e,t,i,n,o){if(!Label.isLoggedIn)return Util.needLogin(),!1;if(0===n&&!confirm(i))return!1;var r={commentId:e};$.ajax({url:Label.servePath+"/comment/thank",type:"POST",headers:{csrfToken:t},cache:!1,data:JSON.stringify(r),error:function(e,t,i){alert(i)},success:function(e,t){if(e.sc){$(o).removeAttr("onclick");var i=$('<svg class="ft-red"><use xlink:href="#heart"></use></svg>'),n=$(o).offset().top,r=$(o).offset().left;i.css({"z-index":9999,top:n,left:r,position:"absolute","font-size":16,"-moz-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none"}),$("body").append(i),i.animate({left:r-150,top:n-60,opacity:0},1e3,function(){var e=parseInt($(o).text());$(o).html('<svg><use xlink:href="#heart"></use></svg> '+(e+1)).addClass("ft-red"),i.remove()})}else alert(e.msg)}})},showReply:function(e,t,i){var n=$(t).closest("li").find("."+i);if("comment-get-comment"===i){if(0!==n.find("li").length)return n.html(""),!1}else if(0===$(t).find(".icon-chevron-down").length)return $(t).find(".icon-chevron-up").removeClass("icon-chevron-up").addClass("icon-chevron-down"),n.html(""),!1;if("0.3"===$(t).css("opacity"))return!1;var o="/comment/replies";"comment-get-comment"===i&&(o="/comment/original"),$.ajax({url:Label.servePath+o,type:"POST",data:JSON.stringify({commentId:e,userCommentViewMode:Label.userCommentViewMode}),beforeSend:function(){$(t).css("opacity","0.3")},success:function(e,i){if(!e.sc)return alert(e.msg),!1;var o=e.commentReplies,r="";o instanceof Array||(o=[o]),0===o.length&&(r='<li class="ft-red">'+Label.removedLabel+"</li>");for(var a=0;a<o.length;a++){var s=o[a];r+='<li><div class="fn-flex">',"someone"!==s.commentAuthorName&&(r+='<a rel="nofollow" href="/member/'+s.commentAuthorName+'">'),r+='<div class="avatar tooltipped tooltipped-se" aria-label="'+s.commentAuthorName+'" style="background-image:url('+s.commentAuthorThumbnailURL+')"></div>',"someone"!==s.commentAuthorName&&(r+="</a>"),r+='<div class="fn-flex-1"><div class="comment-info ft-smaller">',"someone"!==s.commentAuthorName&&(r+='<a class="ft-gray" rel="nofollow" href="/member/'+s.commentAuthorName+'">'),r+=s.commentAuthorName,"someone"!==s.commentAuthorName&&(r+="</a>"),r+='<span class="ft-fade"> • '+s.timeAgo,s.rewardedCnt>0&&(r+='<span aria-label="'+(s.rewarded?Label.thankedLabel:Label.thankLabel+" "+s.rewardedCnt)+'" class="tooltipped tooltipped-n '+(s.rewarded?"ft-red":"ft-fade")+'"> <svg class="fn-text-top"><use xlink:href="#heart"></use></svg> '+s.rewardedCnt+"</span> "),r+=" "+Util.getDeviceByUa(s.commentUA)+"</span>",r+='<a class="tooltipped tooltipped-nw ft-a-title fn-right" aria-label="'+Label.referenceLabel+'" href="javascript:Comment.goComment(\''+Label.servePath+"/article/"+Label.articleOId+"?p="+s.paginationCurrentPageNum+"&m="+Label.userCommentViewMode+"#"+s.oId+'\')"><svg><use xlink:href="#quote"></use></svg></a></div><div class="content-reset comment">'+s.commentContent+"</div></div></div></li>"}n.html("<ul>"+r+"</ul>"),Article.parseLanguage(),$(t).find(".icon-chevron-down").removeClass("icon-chevron-down").addClass("icon-chevron-up")},error:function(e){alert(e.statusText)},complete:function(){$(t).css("opacity","1")}})},add:function(e,t){if(!Validate.goValidate({target:$("#addCommentTip"),data:[{target:Comment.editor,type:"editor",max:2e3,msg:Label.commentErrorLabel}]}))return!1;var i={articleId:e,commentAnonymous:$("#commentAnonymous").prop("checked"),commentContent:Comment.editor.getValue(),userCommentViewMode:Label.userCommentViewMode};$("#replyUseName").data("commentOriginalCommentId")&&(i.commentOriginalCommentId=$("#replyUseName").data("commentOriginalCommentId"));var n=Label.servePath+"/comment",o="POST",r=$("#replyUseName").data("commentId");r&&(n=Label.servePath+"/comment/"+r,o="PUT"),$.ajax({url:n,type:o,headers:{csrfToken:t},cache:!1,data:JSON.stringify(i),beforeSend:function(){$(".form button.red").attr("disabled","disabled").css("opacity","0.3"),Comment.editor.setOption("readOnly","nocursor")},success:function(e,t){if($(".form button.red").removeAttr("disabled").css("opacity","1"),0===e.sc){if(r&&($("#"+r+" > .fn-flex > .fn-flex-1 > .content-reset").html(e.commentContent),$("#"+r+" .icon-history").parent().show()),Comment.editor.setValue(""),$(".editor-preview").html(""),$(".icon-view").hasClass("active")&&$(".icon-view").click(),$(".editor-hide").click(),$("#replyUseName").text("").removeData(),window.localStorage){var i={commentContent:""};window.localStorage[Label.articleOId]=JSON.stringify(i)}1===Label.userCommentViewMode?Comment._bgFade($("#comments")):Comment._bgFade($("#bottomComment"))}else $("#addCommentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#addCommentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")},complete:function(){$(".form button.red").removeAttr("disabled").css("opacity","1"),Comment.editor.setOption("readOnly",!1)}})},reply:function(e,t){Comment._toggleReply(function(){$(window).height()-($("#"+t)[0].offsetTop-$(window).scrollTop()+$("#"+t).outerHeight())<$(".editor-panel .wrapper").outerHeight()&&$(window).scrollTop($("#"+t)[0].offsetTop-($(window).height()-$(".editor-panel .wrapper").outerHeight()-$("#"+t).outerHeight()))});var i="",n=$("#"+t).find(">.fn-flex>div>a").clone();0===n.length?(n=$("#"+t).find(">.fn-flex .avatar").clone(),n.removeClass("avatar").addClass("avatar-small"),i='<a rel="nofollow" href="#'+t+'" class="ft-a-title" onclick="Comment._bgFade($(\'#'+t+'\'))"><span class="icon-reply-to"></span> '+n[0].outerHTML+" "+e+"</a>"):(n.addClass("ft-a-title").attr("href","#"+t).attr("onclick",'Comment._bgFade($("#'+t+'"))'),n.find("div").removeClass("avatar").addClass("avatar-small").after(" "+e).before('<span class="icon-reply-to"></span> '),i=n[0].outerHTML),$("#replyUseName").html(i).data("commentOriginalCommentId",t)}},Article={initAudio:function(){$(".content-audio").each(function(){var e=$(this);new APlayer({element:this,narrow:!1,autoplay:!1,mutex:!0,theme:"#4285f4",preload:"none",mode:"circulation",music:{title:e.data("title"),author:'<a href="https://hacpai.com/article/1464416402922" target="_blank">音乐分享</a>',url:e.data("url"),pic:Label.staticServePath+"/images/music.png"}})});var e=$("#articleAudio");if(0===e.length)return!1;new APlayer({element:document.getElementById("articleAudio"),narrow:!1,autoplay:!1,mutex:!0,theme:"#4285f4",mode:"order",preload:"none",music:{title:"语音预览",author:'<a href="https://hacpai.com/member/v" target="_blank">小薇</a>',url:e.data("url"),pic:Label.staticServePath+"/images/blank.png"}})},permissionTip:function(e){Label.isLoggedIn?Util.alert(e):Util.needLogin()},voteUp:function(e,t,i){if(!Label.isLoggedIn)return Util.needLogin(),!1;var n=$(i),o=n.next();if(n.hasClass("disabled"))return!1;var r={dataId:e};n.addClass("disabled"),$.ajax({url:Label.servePath+"/vote/up/"+t,type:"POST",cache:!1,data:JSON.stringify(r),success:function(e,t){n.removeClass("disabled");var i=parseInt(n.text()),r=parseInt(o.text());if(e.sc)return void(0===e.type?n.html('<svg class="icon-thumbs-up"><use xlink:href="#thumbs-up"></use></svg> '+(i-1)).removeClass("ft-red"):(n.html('<svg class="icon-thumbs-up"><use xlink:href="#thumbs-up"></use></svg> '+(i+1)).addClass("ft-red"),o.hasClass("ft-red")&&o.html('<svg class="icon-thumbs-down"><use xlink:href="#thumbs-down"></use></svg> '+(r-1)).removeClass("ft-red")));alert(e.msg)}})},voteDown:function(e,t,i){if(!Label.isLoggedIn)return Util.needLogin(),!1;var n=$(i),o=n.prev();if(n.hasClass("disabled"))return!1;var r={dataId:e};n.addClass("disabled"),$.ajax({url:Label.servePath+"/vote/down/"+t,type:"POST",cache:!1,data:JSON.stringify(r),success:function(e,t){n.removeClass("disabled");var i=parseInt(o.text()),r=parseInt(n.text());if(e.sc)return 1===e.type?n.html('<svg class="icon-thumbs-down"><use xlink:href="#thumbs-down"></use></svg> '+(r-1)).removeClass("ft-red"):(n.html('<svg class="icon-thumbs-down"><use xlink:href="#thumbs-down"></use></svg> '+(r+1)).addClass("ft-red"),o.hasClass("ft-red")&&o.html('<svg class="icon-thumbs-up"><use xlink:href="#thumbs-up"></use></svg> '+(i-1)).removeClass("ft-red")),!1;alert(e.msg)}})},previewImgAfterLoading:function(){$(".img-preview img").css("transform","translate3d("+Math.max(0,$(window).width()-$(".img-preview img").width())/2+"px, "+Math.max(0,$(window).height()-$(".img-preview img").height())/2+"px, 0)"),setTimeout(function(){$(".img-preview").width($(window).width())},300)},init:function(){this.initToc(),this.share(),this.parseLanguage();var e=null;$(".article").on("dblclick",".content-reset img",function(){clearTimeout(e),$(this).hasClass("emoji")||1===$(this).closest(".editor-panel").length||1===$(this).closest(".ad").length||window.open($(this).attr("src"))}).on("click",".content-reset img",function(t){if(clearTimeout(e),!$(this).hasClass("emoji")&&1!==$(this).closest(".editor-panel").length&&1!==$(this).closest(".ad").length){var i=$(this),n=this;e=setTimeout(function(){var e=n.offsetTop,t=n.offsetLeft;1===i.closest(".comments").length&&(e+=i.closest("li")[0].offsetTop,t=t+$(".comments")[0].offsetLeft+15),$("body").append('<div class="img-preview" onclick="$(this).remove()"><img style="transform: translate3d('+Math.max(0,t)+"px, "+Math.max(0,e-$(window).scrollTop())+'px, 0)" src="'+i.attr("src").split("?imageView2")[0]+'" onload="Article.previewImgAfterLoading()"></div>'),$(".img-preview").css({"background-color":"#fff",position:"fixed"})},100)}});var t=$("#articltVia").data("ua"),i=Util.getDeviceByUa(t);""!==i&&$("#articltVia").text("via "+i),$("#revision").dialog({width:$(window).width()-50,height:$(window).height()-50,modal:!0,hideFooter:!0}),this.initAudio(),$(window).scroll(function(){var e=$(window).scrollTop();e>-1&&e<$(".article .article-body").outerHeight()-48?$(".share").show():$(".share").hide(),e<$(".article-title").offset().top?($(".article-header").css("top","-50px"),$(".nav").show()):($(".article-header").css("top","0"),$(".nav").hide())}),$(window).resize(function(){var e=parseInt($(".article-footer").css("margin-left"))/2-15;if($(".share").css("left",(e<0?0:e)+"px"),$("#articleToC > .module-panel").height($(window).height()-48),$(window).width()<1024)return $(".article-header > h2").removeAttr("style"),0!==$("#articleToC").length&&($(".article-body .wrapper, #articleCommentsPanel, .article-footer").css("margin-right","auto"),!1);if(1===$("#articleToC").length){var t=$("#articleToC").width(),i=($(window).width()-t-$(".article-info").width()-30)/3+t;$(".article-body .wrapper, #articleCommentsPanel, .article-footer").css("margin-right",i+"px")}$(".article-header > h2").css("margin-left",Math.max(20,$(".article-footer").offset().left-58)+"px")})},revision:function(e,t){if(!Label.isLoggedIn)return Util.needLogin(),!1;t||(t="article"),$.ajax({url:Label.servePath+"/"+t+"/"+e+"/revisions",cache:!1,success:function(e,i){if(e.sc){if(0===e.revisions.length||1===e.revisions.length)return $("#revisions").html("<b>"+Label.noRevisionLabel+"</b>"),!1;$("#revisions").html("").prev().remove(),$("#revisions").data("revisions",e.revisions).before('<div class="fn-clear"><div class="pagination"><a href="javascript:void(0)">&lt;</a><span class="current">'+(e.revisions.length-1)+"~"+e.revisions.length+"/"+e.revisions.length+'</span><a href="javascript:void(0)" class="fn-none">&gt;</a></div></div>'),e.revisions.length<=2&&$("#revision a").first().hide();var n=e.revisions[e.revisions.length-1].revisionData.articleTitle+"\n\n"+e.revisions[e.revisions.length-1].revisionData.articleContent,o=e.revisions[e.revisions.length-2].revisionData.articleTitle+"\n\n"+e.revisions[e.revisions.length-2].revisionData.articleContent;return"comment"===t&&(n=e.revisions[e.revisions.length-1].revisionData.commentContent,o=e.revisions[e.revisions.length-2].revisionData.commentContent),Article.mergeEditor=CodeMirror.MergeView(document.getElementById("revisions"),{value:n,origLeft:o,revertButtons:!1,mode:"text/html",collapseIdentical:!0,lineWrapping:!0}),Article._revisionsControls(t),!1}alert(e.msg)}}),$("#revision").dialog("open")},_revisionsControls:function(e){var t=$("#revisions").data("revisions");$("#revision a").first().click(function(){var i=parseInt($("#revision .current").text().split("~")[0]);if(i<=2?$(this).hide():$(this).show(),i<2)return!1;$("#revision a").last().show(),$("#revision .current").html(i-1+"~"+i+"/"+t.length);var n=t[i-1].revisionData.articleTitle+"\n\n"+t[i-1].revisionData.articleContent,o=t[i-2].revisionData.articleTitle+"\n\n"+t[i-2].revisionData.articleContent;"comment"===e&&(n=t[i-1].revisionData.commentContent,o=t[i-2].revisionData.commentContent),Article.mergeEditor.edit.setValue(n),Article.mergeEditor.leftOriginal().setValue(o)}),$("#revision a").last().click(function(){var i=parseInt($("#revision .current").text().split("~")[0]);if(i>t.length-3?$(this).hide():$(this).show(),i>t.length-2)return!1;$("#revision a").first().show(),$("#revision .current").html(i+1+"~"+(i+2)+"/"+t.length);var n=t[i+1].revisionData.articleTitle+"\n\n"+t[i+1].revisionData.articleContent,o=t[i].revisionData.articleTitle+"\n\n"+t[i].revisionData.articleContent;"comment"===e&&(n=t[i+1].revisionData.commentContent,o=t[i].revisionData.commentContent),Article.mergeEditor.edit.setValue(n),Article.mergeEditor.leftOriginal().setValue(o)})},share:function(){var e=parseInt($(".article-footer").css("margin-left"))/2-15;$(".share").css("left",(e<20?20:e)+"px");var t=$("#qrCode").data("shareurl");$("#qrCode").qrcode({width:90,height:90,text:t}),$("body").click(function(){$("#qrCode").slideUp()}),$(".share > span").click(function(){var e=$(this).data("type");if(!e)return!1;if("wechat"===e)return $("#qrCode").slideToggle(),!1;if("copy"===e)return!1;var i=encodeURIComponent(Label.articleTitle+" - "+Label.symphonyLabel),n=encodeURIComponent(t),o=$(".article-info .avatar-mid").css("background-image");pic=o.substring(5,o.length-2);var r={};r.tencent="http://share.v.t.qq.com/index.php?c=share&a=index&title="+i+"&url="+n+"&pic="+pic,r.weibo="http://v.t.sina.com.cn/share/share.php?title="+i+"&url="+n+"&pic="+pic,r.google="https://plus.google.com/share?url="+n,r.twitter="https://twitter.com/intent/tweet?status="+i+" "+n,window.open(r[e],"_blank","top=100,left=200,width=648,height=618")}),$("#qrCode").click(function(){$(this).hide()}),$("#shareClipboard").mouseover(function(){$(this).attr("aria-label",Label.copyLabel)}),Util.clipboard($("#shareClipboard"),$("#shareClipboard").next(),function(){$("#shareClipboard").attr("aria-label",Label.copiedLabel)})},parseLanguage:function(){$("pre code").each(function(e,t){$(this).css("max-height",$(window).height()-68),hljs.highlightBlock(t)})},reward:function(e){confirm(Label.rewardConfirmLabel)&&$.ajax({url:Label.servePath+"/article/reward?articleId="+e,type:"POST",cache:!1,success:function(e,t){if(e.sc){$("#articleRewardContent .content-reset").html(e.articleRewardContent),Article.parseLanguage();var i=$("#articleRewardContent > span"),n=parseInt(i.text());return void i.addClass("ft-red").removeClass("ft-blue").html(n+1+" "+Label.rewardLabel).removeAttr("onclick")}alert(e.msg)},error:function(e){Util.needLogin()}})},thankArticle:function(e,t){return Label.isLoggedIn?!(0===t&&!confirm(Label.thankArticleConfirmLabel))&&(Label.currentUserName===Label.articleAuthorName?(alert(Label.thankSelfLabel),!1):void $.ajax({url:Label.servePath+"/article/thank?articleId="+e,type:"POST",cache:!1,success:function(e,t){if(e.sc){var i=parseInt($("#thankArticle").text());$("#thankArticle").removeAttr("onclick").html('<svg><use xlink:href="#heart"></use></svg><span class="ft-13">'+(i+1)+"</span>").addClass("ft-red").removeClass("ft-blue");var n=$('<svg class="ft-red"><use xlink:href="#heart"></use></svg>'),o=$("#thankArticle").offset().top,r=$("#thankArticle").offset().left;return n.css({"z-index":9999,top:o-20,left:r,position:"absolute","font-size":16,"-moz-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none"}),$("body").append(n),n.animate({top:o-180,opacity:0},1500,function(){n.remove()}),!1}alert(e.msg)}})):(Util.needLogin(),!1)},stick:function(e){confirm(Label.stickConfirmLabel)&&$.ajax({url:Label.servePath+"/article/stick?articleId="+e,type:"POST",cache:!1,success:function(e,t){alert(e.msg),window.location.href=Label.servePath+"/recent"}})},playThought:function(e){var t=function(e,t){var i=e.split("");3===i.length&&i.splice(0,0,"");var n=i[0],o=i[2].split("-"),r=i[3].split("-");if(o[0]=parseInt(o[0]),o[1]=parseInt(o[1]),r[0]=parseInt(r[0]),r[1]=parseInt(r[1]),""===n){for(var a=[],s=o[1],l=0;s<=r[1];s++,l++){if(o[1]===r[1]){t[s]=t[s].substring(0,o[0])+t[s].substr(r[0]);break}s===o[1]?t[s]=t[s].substr(0,o[0]):s===r[1]?(t[o[1]]+=t[s].substr(r[0]),t.splice(s,1)):a.push(s)}for(var c=0;c<a.length;c++)t.splice(a[c]-c,1)}else{var d=n.split(String.fromCharCode(29))[0];""===n.split(String.fromCharCode(29))[1]&&(t[o[1]]=t[o[1]].substring(0,o[0])+t[r[1]].substr(r[0])),t[o[1]]=t[o[1]].substring(0,o[0])+d+t[o[1]].substr(o[0])}return t},i=e.split("");""===i[i.length-1]&&i.pop();for(var n=0,o=0;n<i.length;n++)setTimeout(function(){$(".article-content").data("text")||$(".article-content").data("text","");var e=t(i[o++],$(".article-content").data("text").split(String.fromCharCode(10))),n=e.join(String.fromCharCode(10)),r=n.replace(/\n/g,"<br>").replace(/ /g,"&nbsp;").replace(/	/g,"&nbsp;&nbsp;&nbsp;&nbsp;");$(".article-content").data("text",n).html(r)},parseInt(i[n].split("")[1])/2);for(var r=0,a=parseInt(i[n-1].split("")[1])/2+120,s=setInterval(function(){r>=a?($("#thoughtProgress .bar").width("100%"),$("#thoughtProgress .icon-video").css("left","100%"),clearInterval(s)):(r+=20,$("#thoughtProgress .icon-video").css("left",100*r/a+"%"),$("#thoughtProgress .bar").width(100*r/a+"%"))},20),l=0,c=0;l<i.length;l++){var d=t(i[c++],$("#thoughtProgressPreview").data("text").split(String.fromCharCode(10))),m=d.join(String.fromCharCode(10)),u=m.replace(/\n/g,"<br>").replace(/ /g,"&nbsp;").replace(/	/g,"&nbsp;&nbsp;&nbsp;&nbsp;");$("#thoughtProgressPreview").data("text",m).html(u)}$("#thoughtProgressPreview").dialog({modal:!0,hideFooter:!0}),$("#thoughtProgress .icon-video").click(function(){$("#thoughtProgressPreview").dialog("open")}),$(".article-content").html(u).height($(".article-content").height()).html("")},initToc:function(){if(0===$("#articleToC").length)return $(".article-header > h2").css("margin-left",Math.max(20,$(".article-footer").offset().left-58)+"px"),$(".article-body .wrapper, #articleCommentsPanel, .article-footer").css("margin-right","auto"),!1;var e=$("#articleToC").width(),t=($(window).width()-e-$(".article-info").width()-30)/3+e;$(".article-body .wrapper, #articleCommentsPanel, .article-footer").css("margin-right",t+"px"),$(".article-header > h2").css("margin-left",Math.max(20,$(".article-footer").offset().left-58)+"px"),$("#articleToC > .module-panel").height($(window).height()-48);var i=$("#articleToC"),n=$(".article-toc"),o=$(".article-content [id^=toc]"),r=!1;i.offset().top;toc=[],i.find("li").click(function(){var e=$(this);setTimeout(function(){i.find("li").removeClass("current"),e.addClass("current")},50)}),$(window).scroll(function(e){if(parseInt($("#articleToC").css("right"))<0)return!1;$("#articleToC > .module-panel").height($(window).height()-49),toc=[],o.each(function(e){toc.push({id:this.id,offsetTop:this.offsetTop})});for(var t=$(window).scrollTop(),a=0,s=toc.length;a<s;a++)if(t<toc[a].offsetTop-53){i.find("li").removeClass("current");var l=a>0?a-1:0;i.find('a[data-id="'+toc[l].id+'"]').parent().addClass("current");break}t>=toc[toc.length-1].offsetTop-53&&(i.find("li").removeClass("current"),i.find("li:last").addClass("current"));var c=i.find("li.current")[0].offsetTop;r||(n.scrollTop()<c-n.height()+30&&n.scrollTop(c-n.height()+30),n.scrollTop()>c-30&&n.scrollTop(c)),setTimeout(function(){r=!1},600)}),$(window).scroll(),n.scrollTop(i.find("li.current")[0].offsetTop).scroll(function(){r=!0})},toggleToc:function(){var e=$("#articleToC");if(0===e.length)return!1;var t=$(".article-header .icon-unordered-list");t.hasClass("ft-red")?(e.animate({right:"-"+$("#articleToC").outerWidth()+"px"}),t.removeClass("ft-red"),$(".article-actions  .icon-unordered-list").removeClass("ft-red")):(e.animate({right:0}),t.addClass("ft-red"),$(".article-actions  .icon-unordered-list").addClass("ft-red"))},makeNotificationRead:function(e,t){var i={articleId:e,commentIds:t};$.ajax({url:Label.servePath+"/notification/read",type:"POST",cache:!1,data:JSON.stringify(i)})}};Article.init(),$(document).ready(function(){Comment.init(),Util.uploadFile({type:"img",id:"fileUpload",pasteZone:$(".CodeMirror"),qiniuUploadToken:Label.qiniuUploadToken,editor:Comment.editor,uploadingLabel:Label.uploadingLabel,qiniuDomain:Label.qiniuDomain,imgMaxSize:Label.imgMaxSize,fileMaxSize:Label.fileMaxSize}),ArticleChannel.init(Label.articleChannel),Label.isLoggedIn&&(Article.makeNotificationRead(Label.articleOId,Label.notificationCmtIds),setTimeout(function(){Util.setUnreadNotificationCount()},1e3))});