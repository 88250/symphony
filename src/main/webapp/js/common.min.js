function arraycopy(e,o,a,t,r){for(i=0;i<r;i++)a[t+i]=e[o+i]}function arrayEquals(e,o){if("undefined"==e||"undefined"==o)return!1;if(e instanceof Array&&o instanceof Array){if(e.length!=o.length)return!1;for(i=0;i<e.length;i++)if(e[i]!=o[i])return!1;return!0}return!1}function isImage(e){return null!==getImageMime(e)}function getImageMime(e){if(null==e||"undefined"==e||e.length<8)return null;var o=[];return arraycopy(e,0,o,0,6),isGif(o)?"image/gif":(o=[],arraycopy(e,6,o,0,4),isJpeg(o)?"image/jpeg":(o=[],arraycopy(e,0,o,0,8),isPng(o)?"image/png":null))}function isAudio(e){if(null==e||"undefined"==e||e.length<12)return null;var o=[];arraycopy(e,0,o,0,4);var a=[];return arraycopy(e,8,a,0,4),isWav(o,a)?"audio/wav":null}function isGif(e){return arrayEquals(e,gifMagic0)||arrayEquals(e,getGifMagic1)}function isJpeg(e){return arrayEquals(e,jpegMagic)||arrayEquals(e,jpeg_jfif)||arrayEquals(e,jpeg_exif)}function isPng(e){return arrayEquals(e,pngMagic)}function isWav(e,o){return arrayEquals(e,wavMagic1)&&arrayEquals(o,wavMagic2)}function getUUID(){var e=(new Date).getTime(),o="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){var a=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==o?a:3&a|8).toString(16)});return o=o.replace(new RegExp("-","g"),"")}var Util={prevKey:void 0,_initCommonHotKey:function(){if(!Label.userKeyboardShortcutsStatus||"1"===Label.userKeyboardShortcutsStatus)return!1;var e=function(e){var o=$(".list > ul > li.focus");if(1===o.length){if("top"===e||"bottom"===e)return $(window).scrollTop(o.offset().top),!1;($(window).height()+$(window).scrollTop()<o.offset().top+o.outerHeight()||$(window).scrollTop()>o.offset().top)&&("down"===e?$(window).scrollTop(o.offset().top-($(window).height()-o.outerHeight())):$(window).scrollTop(o.offset().top))}};0===$("#articleTitle").length&&$(document).bind("keydown","c",function(e){return Util.prevKey?!1:(window.location=Label.servePath+"/post?type=0",!1)}),$(document).bind("keyup","g",function(){return Util.prevKey="g",setTimeout(function(){Util.prevKey=void 0},1e3),!1}).bind("keyup","s",function(){return $("#search").focus(),!1}).bind("keyup","t",function(){return void 0===Util.prevKey&&Util.goTop(),!1}).bind("keyup","n",function(e){return"g"===Util.prevKey&&(window.location=Label.servePath+"/notifications"),!1}).bind("keyup","h",function(e){return"g"===Util.prevKey&&(window.location=Label.servePath+"/hot"),!1}).bind("keyup","i",function(e){return"g"===Util.prevKey&&(window.location=Label.servePath),!1}).bind("keyup","r",function(e){return"g"===Util.prevKey&&(window.location=Label.servePath+"/recent"),!1}).bind("keyup","p",function(e){return"g"===Util.prevKey&&(window.location=Label.servePath+"/perfect"),!1}).bind("keyup","t",function(e){return"g"===Util.prevKey&&(window.location=Label.servePath+"/timeline"),!1}).bind("keyup","Shift+/",function(e){return window.open("https://hacpai.com/article/1474030007391"),!1}).bind("keyup","j",function(o){var a=".content .list > ul > ";1===$("#comments").length&&(a="#comments .list > ul > ");var t=$(a+"li.focus");return 0===t.length?$(a+"li:first").addClass("focus"):1===t.next().length&&(t.next().addClass("focus"),t.removeClass("focus")),e("down"),!1}).bind("keyup","k",function(o){var a=".content .list > ul > ";1===$("#comments").length&&(a="#comments .list > ul > ");var t=$(a+"li.focus");return 0===t.length?$(a+"li:last").addClass("focus"):1===t.prev().length&&(t.prev().addClass("focus"),t.removeClass("focus")),e("up"),!1}).bind("keyup","f",function(o){var a=".content .list > ul > ";return 1===$("#comments").length&&(a="#comments .list > ul > "),$(a+"li.focus").removeClass("focus"),$(a+"li:first").addClass("focus"),e("top"),!1}).bind("keyup","l",function(o){if(Util.prevKey)return!1;var a=".content .list > ul > ";return 1===$("#comments").length&&(a="#comments .list > ul > "),$(a+"li.focus").removeClass("focus"),$(a+"li:last").addClass("focus"),e("bottom"),!1}).bind("keyup","o",function(e){var o=".content .list > ul > ";1===$("#comments").length&&(o="#comments .list > ul > ");var a=$(o+"li.focus .fn-flex-1 h2 > a").attr("href");return a&&(window.location=a),!1}).bind("keyup","return",function(e){var o=".content .list > ul > ";1===$("#comments").length&&(o="#comments .list > ul > ");var a=$(o+"li.focus .fn-flex-1 h2 > a").attr("href");return a&&(window.location=a),!1})},notifyMsg:function(e){if(!("Notification"in window))return!1;var o=function(e){var o=new Notification(Label.visionLabel,{body:Label.desktopNotificationTemplateLabel.replace("${count}",e),icon:Label.staticServePath+"/images/faviconH.png"});o.onclick=o.onerror=function(){window.location=Label.servePath+"/notifications"}};"granted"===Notification.permission?o(e):"denied"!==Notification.permission&&Notification.requestPermission(function(a){"granted"===a&&o(e)})},linkForge:function(){$(".link-forge .module-header > a").click(function(){var e=$(this).closest(".module").find(".module-panel");return"hidden"!==e.css("overflow")?(e.css({"max-height":"409px",overflow:"hidden"}),!1):void e.css({"max-height":"inherit",overflow:"inherit"})});var e=function(){return Label.isLoggedIn?void(Validate.goValidate({target:$("#uploadLinkTip"),data:[{target:$(".link-forge-upload input"),type:"url",msg:Label.invalidUserURLLabel}]})&&$.ajax({url:Label.servePath+"/forge/link",type:"POST",cache:!1,data:JSON.stringify({url:$(".link-forge-upload input").val()}),error:function(e,o,a){alert(a)},success:function(e,o){e.sc?($("#uploadLinkTip").html("<ul><li>"+Label.forgeUploadSuccLabel+"</li></ul>").addClass("succ"),$(".link-forge-upload input").val(""),setTimeout(function(){$("#uploadLinkTip").html("").removeClass("succ")},5e3)):alert(e.msg)}})):(Util.needLogin(),!1)};$(".link-forge-upload button").click(function(){e()}),$(".link-forge-upload input").focus().keypress(function(o){return 13===o.which?(e(),!1):void Validate.goValidate({target:$("#uploadLinkTip"),data:[{target:$(".link-forge-upload input"),type:"url",msg:Label.invalidUserURLLabel}]})})},processClipBoard:function(e,o){var e=toMarkdown(e,{converters:[{filter:"img",replacement:function(e,a){if(1===a.attributes.length)return"";var t={url:a.src};return $.ajax({url:Label.servePath+"/fetch-upload",type:"POST",data:JSON.stringify(t),cache:!1,success:function(e,a){if(e.sc){var t=o.getValue();t=t.replace(e.originalURL,e.url),o.setValue(t)}}}),"![]("+a.src+")"}}],gfm:!0});return e=$("<div>"+e+"</div>").text().replace(/\n{2,}/g,"\n\n").replace(/ /g," "),$.trim(e)},getParameterByName:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o=new RegExp("[\\?&]"+e+"=([^&#]*)"),a=o.exec(location.search);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))},getDeviceByUa:function(e){$.ua.set(e);var o=$.ua.device.model?$.ua.device.model:$.ua.os.name;return o&&"Windows"!==o||(o=""),o},initSearch:function(e,o,a){var t=algoliasearch(e,o),i=t.initIndex(a);$("#search").autocomplete({hint:!1,templates:{footer:'<div class="fn-right fn-pointer" onclick="window.open(\'https://www.algolia.com/referrals/1faf0d17/join\')"><span class="ft-gray">With &hearts; from</span> <img src="'+Label.staticServePath+'/images/services/algolia128x40.png" /> </div>'}},[{source:function(e,o){i.search(e,{hitsPerPage:20},function(e,a){return e?void o([]):void o(a.hits,a)})},displayKey:"name",templates:{suggestion:function(e){return e._highlightResult.articleTitle.value}}}]).on("autocomplete:selected",function(e,o,a){window.open("/article/"+o.oId)}).bind("keyup","esc",function(){$(this).blur()})},initTextarea:function(e,o){var a={$it:$("#"+e),setValue:function(e){this.$it.val(e)},getValue:function(){return this.$it.val()},setOption:function(e,o){this.$it.prop(e,o)},focus:function(){this.$it.focus()}};return o&&"function"==typeof o&&a.$it.keyup(function(){o(a)}),a},initCodeMirror:function(){var e="+1,-1,100,1234,8ball,a,ab,abc,abcd,accept,aerial_tramway,airplane,alarm_clock,alien,ambulance,anchor,angel,anger,angry,anguished,ant,apple,aquarius,aries,arrow_backward,arrow_double_down,arrow_double_up,arrow_down,arrow_down_small,arrow_forward,arrow_heading_down,arrow_heading_up,arrow_left,arrow_lower_left,arrow_lower_right,arrow_right,arrow_right_hook,arrow_up,arrow_up_down,arrow_up_small,arrow_upper_left,arrow_upper_right,arrows_clockwise,arrows_counterclockwise,art,articulated_lorry,astonished,atm,b,baby,baby_bottle,baby_chick,baby_symbol,back,baggage_claim,balloon,ballot_box_with_check,bamboo,banana,bangbang,bank,bar_chart,barber,baseball,basketball,bath,bathtub,battery,bear,bee,beer,beers,beetle,beginner,bell,bento,bicyclist,bike,bikini,bird,birthday,black_circle,black_joker,black_medium_small_square,black_medium_square,black_nib,black_small_square,black_square,black_square_button,blossom,blowfish,blue_book,blue_car,blue_heart,blush,boar,boat,bomb,book,bookmark,bookmark_tabs,books,boom,boot,bouquet,bow,bowling,bowtie,boy,bread,bride_with_veil,bridge_at_night,briefcase,broken_heart,bug,bulb,bullettrain_front,bullettrain_side,bus,busstop,bust_in_silhouette,busts_in_silhouette,cactus,cake,calendar,calling,camel,camera,cancer,candy,capital_abcd,capricorn,car,card_index,carousel_horse,cat,cat2,cd,chart,chart_with_downwards_trend,chart_with_upwards_trend,checkered_flag,cherries,cherry_blossom,chestnut,chicken,children_crossing,chocolate_bar,christmas_tree,church,cinema,circus_tent,city_sunrise,city_sunset,cl,clap,clapper,clipboard,clock1,clock10,clock1030,clock11,clock1130,clock12,clock1230,clock130,clock2,clock230,clock3,clock330,clock4,clock430,clock5,clock530,clock6,clock630,clock7,clock730,clock8,clock830,clock9,clock930,closed_book,closed_lock_with_key,closed_umbrella,cloud,clubs,cn,cocktail,coffee,cold_sweat,collision,computer,confetti_ball,confounded,confused,congratulations,construction,construction_worker,convenience_store,cookie,cool,cop,copyright,corn,couple,couple_with_heart,couplekiss,cow,cow2,credit_card,crescent_moon,crocodile,crossed_flags,crown,cry,crying_cat_face,crystal_ball,cupid,curly_loop,currency_exchange,curry,custard,customs,cyclone,dancer,dancers,dango,dart,dash,date,de,deciduous_tree,department_store,diamond_shape_with_a_dot_inside,diamonds,disappointed,disappointed_relieved,dizzy,dizzy_face,do_not_litter,dog,dog2,dollar,dolls,dolphin,donut,door,doughnut,dragon,dragon_face,dress,dromedary_camel,droplet,dvd,e-mail,ear,ear_of_rice,earth_africa,earth_americas,earth_asia,egg,eggplant,eight,eight_pointed_black_star,eight_spoked_asterisk,electric_plug,elephant,email,end,envelope,es,euro,european_castle,european_post_office,evergreen_tree,exclamation,expressionless,eyeglasses,eyes,facepunch,factory,fallen_leaf,family,fast_forward,fax,fearful,feelsgood,feet,ferris_wheel,file_folder,finnadie,fire,fire_engine,fireworks,first_quarter_moon,first_quarter_moon_with_face,fish,fish_cake,fishing_pole_and_fish,fist,five,flags,flashlight,floppy_disk,flower_playing_cards,flushed,foggy,football,fork_and_knife,fountain,four,four_leaf_clover,fr,free,fried_shrimp,fries,frog,frowning,fu,fuelpump,full_moon,full_moon_with_face,game_die,gb,gem,gemini,ghost,gift,gift_heart,girl,globe_with_meridians,goat,goberserk,godmode,golf,grapes,green_apple,green_book,green_heart,grey_exclamation,grey_question,grimacing,grin,grinning,guardsman,guitar,gun,haircut,hamburger,hammer,hamster,hand,handbag,hankey,hash,hatched_chick,hatching_chick,headphones,hear_no_evil,heart,heart_decoration,heart_eyes,heart_eyes_cat,heartbeat,heartpulse,hearts,heavy_check_mark,heavy_division_sign,heavy_dollar_sign,heavy_exclamation_mark,heavy_minus_sign,heavy_multiplication_x,heavy_plus_sign,helicopter,herb,hibiscus,high_brightness,high_heel,hocho,honey_pot,honeybee,horse,horse_racing,hospital,hotel,hotsprings,hourglass,hourglass_flowing_sand,house,house_with_garden,hurtrealbad,hushed,ice_cream,icecream,id,ideograph_advantage,imp,inbox_tray,incoming_envelope,information_desk_person,information_source,innocent,interrobang,iphone,it,izakaya_lantern,jack_o_lantern,japan,japanese_castle,japanese_goblin,japanese_ogre,jeans,joy,joy_cat,jp,key,keycap_ten,kimono,kiss,kissing,kissing_cat,kissing_closed_eyes,kissing_face,kissing_heart,kissing_smiling_eyes,koala,koko,kr,large_blue_circle,large_blue_diamond,large_orange_diamond,last_quarter_moon,last_quarter_moon_with_face,laughing,leaves,ledger,left_luggage,left_right_arrow,leftwards_arrow_with_hook,lemon,leo,leopard,libra,light_rail,link,lips,lipstick,lock,lock_with_ink_pen,lollipop,loop,loudspeaker,love_hotel,love_letter,low_brightness,m,mag,mag_right,mahjong,mailbox,mailbox_closed,mailbox_with_mail,mailbox_with_no_mail,man,man_with_gua_pi_mao,man_with_turban,mans_shoe,maple_leaf,mask,massage,meat_on_bone,mega,melon,memo,mens,metal,metro,microphone,microscope,milky_way,minibus,minidisc,mobile_phone_off,money_with_wings,moneybag,monkey,monkey_face,monorail,mortar_board,mount_fuji,mountain_bicyclist,mountain_cableway,mountain_railway,mouse,mouse2,movie_camera,moyai,muscle,mushroom,musical_keyboard,musical_note,musical_score,mute,nail_care,name_badge,neckbeard,necktie,negative_squared_cross_mark,neutral_face,new,new_moon,new_moon_with_face,newspaper,ng,nine,no_bell,no_bicycles,no_entry,no_entry_sign,no_good,no_mobile_phones,no_mouth,no_pedestrians,no_smoking,non-potable_water,nose,notebook,notebook_with_decorative_cover,notes,nut_and_bolt,o,o2,ocean,octocat,octopus,oden,office,ok,ok_hand,ok_woman,older_man,older_woman,on,oncoming_automobile,oncoming_bus,oncoming_police_car,oncoming_taxi,one,open_file_folder,open_hands,open_mouth,ophiuchus,orange_book,outbox_tray,ox,package,page_facing_up,page_with_curl,pager,palm_tree,panda_face,paperclip,parking,part_alternation_mark,partly_sunny,passport_control,paw_prints,peach,pear,pencil,pencil2,penguin,pensive,performing_arts,persevere,person_frowning,person_with_blond_hair,person_with_pouting_face,phone,pig,pig2,pig_nose,pill,pineapple,pisces,pizza,plus1,point_down,point_left,point_right,point_up,point_up_2,police_car,poodle,poop,post_office,postal_horn,postbox,potable_water,pouch,poultry_leg,pound,pouting_cat,pray,princess,punch,purple_heart,purse,pushpin,put_litter_in_its_place,question,rabbit,rabbit2,racehorse,radio,radio_button,rage,rage1,rage2,rage3,rage4,railway_car,rainbow,raised_hand,raised_hands,raising_hand,ram,ramen,rat,recycle,red_car,red_circle,registered,relaxed,relieved,repeat,repeat_one,restroom,revolving_hearts,rewind,ribbon,rice,rice_ball,rice_cracker,rice_scene,ring,rocket,roller_coaster,rooster,rose,rotating_light,round_pushpin,rowboat,ru,rugby_football,runner,running,running_shirt_with_sash,sa,sagittarius,sailboat,sake,sandal,santa,satellite,satisfied,saxophone,school,school_satchel,scissors,scorpius,scream,scream_cat,scroll,seat,secret,see_no_evil,seedling,seven,shaved_ice,sheep,shell,ship,shipit,shirt,shit,shoe,shower,signal_strength,six,six_pointed_star,ski,skull,sleeping,sleepy,slot_machine,small_blue_diamond,small_orange_diamond,small_red_triangle,small_red_triangle_down,smile,smile_cat,smiley,smiley_cat,smiling_imp,smirk,smirk_cat,smoking,snail,snake,snowboarder,snowflake,snowman,sob,soccer,soon,sos,sound,space_invader,spades,spaghetti,sparkle,sparkler,sparkles,sparkling_heart,speak_no_evil,speaker,speech_balloon,speedboat,squirrel,star,star2,stars,station,statue_of_liberty,steam_locomotive,stew,straight_ruler,strawberry,stuck_out_tongue,stuck_out_tongue_closed_eyes,stuck_out_tongue_winking_eye,sun_with_face,sunflower,sunglasses,sunny,sunrise,sunrise_over_mountains,surfer,sushi,suspect,suspension_railway,sweat,sweat_drops,sweat_smile,sweet_potato,swimmer,symbols,syringe,tada,tanabata_tree,tangerine,taurus,taxi,tea,telephone,telephone_receiver,telescope,tennis,tent,thought_balloon,three,thumbsdown,thumbsup,ticket,tiger,tiger2,tired_face,tm,toilet,tokyo_tower,tomato,tongue,top,tophat,tractor,traffic_light,train,train2,tram,triangular_flag_on_post,triangular_ruler,trident,triumph,trolleybus,trollface,trophy,tropical_drink,tropical_fish,truck,trumpet,tshirt,tulip,turtle,tv,twisted_rightwards_arrows,two,two_hearts,two_men_holding_hands,two_women_holding_hands,u5272,u5408,u55b6,u6307,u6708,u6709,u6e80,u7121,u7533,u7981,u7a7a,uk,umbrella,unamused,underage,unlock,up,us,v,vertical_traffic_light,vhs,vibration_mode,video_camera,video_game,violin,virgo,volcano,vs,walking,waning_crescent_moon,waning_gibbous_moon,warning,watch,water_buffalo,watermelon,wave,wavy_dash,waxing_crescent_moon,waxing_gibbous_moon,wc,weary,wedding,whale,whale2,wheelchair,white_check_mark,white_circle,white_flower,white_large_square,white_medium_small_square,white_medium_square,white_small_square,white_square_button,wind_chime,wine_glass,wink,wolf,woman,womans_clothes,womans_hat,womens,worried,wrench,x,yellow_heart,yen,yum,zap,zero,zzz",o="";if($.ajax({async:!1,url:Label.servePath+"/users/emotions",type:"GET",success:function(e){o=e.emotions}}),""===o)o=e;else{for(var a=o.split(","),t=0;t<a.length;t++)e=e.replace(a[t]+",",",");o=o+","+e}o=o.replace(/,+/g,",");for(var i=o.split(/,/),r=[],n=0;n<i.length;n++){var l=i[n],s=i[n];r.push({displayText:"<span>"+l+'&nbsp;<img style="width: 16px" src="'+Label.staticServePath+"/js/lib/emojify.js-1.1.0/images/basic/"+s+'.png"></span>',text:s+": "})}CodeMirror.registerHelper("hint","userName",function(e){for(var o=/[\w$]+/,a=e.getCursor(),t=e.getLine(a.line),i=a.ch,r=i;r<t.length&&o.test(t.charAt(r));)++r;for(;i&&o.test(t.charAt(i-1));)--i;var n=e.getTokenAt(a),l=[];return 0!==n.string.indexOf("@")?!1:($.ajax({async:!1,url:Label.servePath+"/users/names?name="+n.string.substring(1),type:"GET",success:function(o){if(o.sc&&o.userNames){for(var a=0;a<o.userNames.length;a++){var t=o.userNames[a],i=t.userName,r=t.userAvatarURL;l.push({displayText:"<span style='font-size: 1rem;line-height:22px'><img style='width: 1rem;height: 1rem;margin:3px 0;float:left' src='"+r+"'> "+i+"</span>",text:i+" "})}"comment"===e["for"]&&l.push({displayText:"<span style='font-size: 1rem;line-height:22px'><img style='width: 1rem;height: 1rem;margin:3px 0;float:left' src='/images/user-thumbnail.png'> @参与者</span>",text:"participants "})}}}),{list:l,from:CodeMirror.Pos(a.line,i),to:CodeMirror.Pos(a.line,r)})}),CodeMirror.registerHelper("hint","emoji",function(e){for(var o=/[\w$]+/,a=e.getCursor(),t=e.getLine(a.line),r=a.ch,n=r;n<t.length&&o.test(t.charAt(n));)++n;for(;r&&o.test(t.charAt(r-1));)--r;for(var l=e.getTokenAt(a),s=[],c=l.string.trim(),u=0,d=0;d<i.length;d++){var g=i[d],p=i[d];if(Util.startsWith(p,c)&&(s.push({displayText:'<span style="font-size: 1rem;line-height:22px"><img style="width: 1rem;margin:3px 0;float:left" src="'+Label.staticServePath+"/js/lib/emojify.js-1.1.0/images/basic/"+p+'.png"> '+g.toString()+"</span>",text:":"+p+": "}),u++),u>10)break}return{list:s,from:CodeMirror.Pos(a.line,r),to:CodeMirror.Pos(a.line,n)}}),CodeMirror.commands.autocompleteUserName=function(e){return e.showHint({hint:CodeMirror.hint.userName,completeSingle:!1}),CodeMirror.Pass},CodeMirror.commands.autocompleteEmoji=function(e){return e.showHint({hint:CodeMirror.hint.emoji,completeSingle:!1}),CodeMirror.Pass},CodeMirror.commands.startAudioRecord=function(e){if(Audio.availabel||Audio.init(),Audio.availabel){Audio.handleStartRecording();var o=e.getCursor();e.replaceRange(Label.audioRecordingLabel,o,o)}},CodeMirror.commands.endAudioRecord=function(e){if(Audio.availabel){Audio.handleStopRecording();var o=e.getCursor();e.replaceRange(Label.uploadingLabel,CodeMirror.Pos(o.line,o.ch-Label.audioRecordingLabel.length),o);var a=Audio.wavFileBlob.getDataBlob(),t=Math.floor(100*Math.random())+""+(new Date).getTime()+Math.floor(100*Math.random())+".wav",i=new FileReader;i.onload=function(o){if(""!==qiniuToken){var i=new FormData;i.append("token",qiniuToken),i.append("file",a),i.append("key",t),$.ajax({type:"POST",url:"https://up.qbox.me/",data:i,processData:!1,contentType:!1,paramName:"file",success:function(o){var a=e.getCursor();e.replaceRange('<audio controls="controls" src="'+qiniuDomain+"/"+t+'"></audio>\n\n',CodeMirror.Pos(a.line,a.ch-Label.uploadingLabel.length),a)},error:function(o,a,t){alert("Error: "+t);var i=e.getCursor();e.replaceRange("",CodeMirror.Pos(i.line,i.ch-Label.uploadingLabel.length),i)}})}else{var i=new FormData;i.append("file",a),i.append("key",t),$.ajax({type:"POST",url:Label.servePath+"/upload",data:i,processData:!1,contentType:!1,paramName:"file",success:function(o){var a=e.getCursor();e.replaceRange('<audio controls="controls" src="'+o.key+'"></audio>\n\n',CodeMirror.Pos(a.line,a.ch-Label.uploadingLabel.length),a)},error:function(o,a,t){alert("Error: "+t);var i=e.getCursor();e.replaceRange("",CodeMirror.Pos(i.line,i.ch-Label.uploadingLabel.length),i)}})}},i.readAsDataURL(a)}}},_initArticlePreview:function(){$(".article-list h2 > a").hover(function(){var e=$(this);if(3===e.data("type"))return!1;e.addClass("previewing");var o=e.closest("li"),a='<div class="preview"><span class="ico-arrow"></span><span class="ico-arrowborder"></span>';return $(".article-list .preview").hide(),1===o.find(".preview").length?(o.find(".preview").show(),!1):1===o.find(".no-preview").length?!1:void setTimeout(function(){return e.hasClass("previewing")?void $.ajax({url:Label.servePath+"/article/"+e.data("id")+"/preview",type:"GET",cache:!1,success:function(e,t){return e.sc&&""!==$.trim(e.html)?(o.append(a+e.html+"</div>"),void o.find(".preview").show()):(o.append('<div class="no-preview"></div>'),!1)}}):!1},800)},function(){var e=$(this).closest("li");e.find(".preview").hide(),$(this).removeClass("previewing")})},setUnreadNotificationCount:function(){$.ajax({url:Label.servePath+"/notification/unread/count",type:"GET",cache:!1,success:function(e,o){var a=e.unreadNotificationCount;a>0?($("#aNotifications").removeClass("no-msg").addClass("msg").text(a),window.localStorage&&a!==Number(window.localStorage.unreadNotificationCount)&&0===e.userNotifyStatus&&(Util.notifyMsg(a),window.localStorage.unreadNotificationCount=a)):($("#aNotifications").removeClass("msg").addClass("no-msg").text(a),window.localStorage&&(window.localStorage.unreadNotificationCount=0))}})},follow:function(e,o,a,t){if(!Label.isLoggedIn)return Util.needLogin(),!1;if($(e).hasClass("disabled"))return!1;var i={followingId:o};$(e).addClass("disabled"),$.ajax({url:Label.servePath+"/follow/"+a,type:"POST",cache:!1,data:JSON.stringify(i),success:function(i,r){i.sc&&($(e).removeClass("disabled"),"undefined"!=typeof t?$(e).html('<span class="icon-star"></span> '+(t+1)).attr("onclick","Util.unfollow(this, '"+o+"', '"+a+"', "+(t+1)+")").attr("aria-label",Label.uncollectLabel).addClass("ft-red"):$(e).attr("onclick","Util.unfollow(this, '"+o+"', '"+a+"')").text("article"===a?Label.uncollectLabel:Label.unfollowLabel))},complete:function(){$(e).removeClass("disabled")}})},unfollow:function(e,o,a,t){if($(e).hasClass("disabled"))return!1;var i={followingId:o};$(e).addClass("disabled"),$.ajax({url:Label.servePath+"/follow/"+a,type:"DELETE",cache:!1,data:JSON.stringify(i),success:function(i,r){i.sc&&("undefined"!=typeof t?$(e).removeClass("ft-red").html('<span class="icon-star"></span> '+(t-1)).attr("onclick","Util.follow(this, '"+o+"', '"+a+"',"+(t-1)+")").attr("aria-label",Label.collectLabel):$(e).attr("onclick","Util.follow(this, '"+o+"', '"+a+"')").text("article"===a?Label.collectLabel:Label.followLabel))},complete:function(){$(e).removeClass("disabled")}})},goTop:function(){$("html, body").animate({scrollTop:0},800)},showLogin:function(){$(".nav .form").show(),$("#nameOrEmail").focus()},needLogin:function(){alert(Label.funNeedLoginLabel)},goRegister:function(){return-1!==location.href.indexOf("/register")?void window.location.reload():void(window.location.href=Label.servePath+"/register?goto="+encodeURIComponent(location.href))},_kill:function(){"IE"===$.ua.browser.name&&parseInt($.ua.browser.version)<10&&$.ajax({url:Label.servePath+"/kill-browser",type:"GET",cache:!1,success:function(e,o){$("body").append(e),$("#killBrowser").dialog({modal:!0,hideFooter:!0,height:345,width:600}),$("#killBrowser").dialog("open")}})},_initActivity:function(){var e=$(".person-info"),o=e.data("percent"),a=0,t=0,i=0;25>=o?a=parseInt(o/.25):75>=o?(a=100,t=parseInt((o-25)/2/.25)):100>=o&&(a=100,t=100,i=parseInt((o-75)/.25)),e.find(".bottom").css({width:a+"%",left:(100-a)/2+"%"}),e.find(".top-left").css({width:parseInt(i/2)+"%",left:0}),e.find(".top-right").css({width:parseInt(i/2)+"%",right:0}),e.find(".left").css({height:t+"%",top:100-t+"%"}),e.find(".right").css({height:t+"%",top:100-t+"%"})},init:function(e){return this._kill(),this._initNav(),this._initActivity(),this._initArticlePreview(),$("#loginPassword").keyup(function(e){13===e.keyCode&&Util.login()}),$(".nav .icon-search").click(function(){$(".nav input.search").focus()}),$(".nav input.search").focus(function(){$(".nav .tags").css("visibility","hidden")}).blur(function(){$(".nav .tags").css("visibility","visible")}),$(window).scroll(function(){$(window).scrollTop()>20?$(".go-up").show():$(".go-up").hide()}),e&&(Util.setUnreadNotificationCount(),setInterval(function(){Util.setUnreadNotificationCount()},6e4)),this._initCommonHotKey(),console.log("%cCopyright © 2012-%s, b3log.org & hacpai.com\n\n%cHacPai%c 平等、自由、奔放\n\n%cFeel easy about trust.","font-size:12px;color:#999999;",(new Date).getFullYear(),'font-family: "Helvetica Neue", "Luxi Sans", "DejaVu Sans", Tahoma, "Hiragino Sans GB", "Microsoft Yahei", sans-serif;font-size:64px;color:#404040;-webkit-text-fill-color:#404040;-webkit-text-stroke: 1px #777;','font-family: "Helvetica Neue", "Luxi Sans", "DejaVu Sans", Tahoma, "Hiragino Sans GB", "Microsoft Yahei", sans-serif;font-size:12px;color:#999999; font-style:italic;','font-family: "Helvetica Neue", "Luxi Sans", "DejaVu Sans", Tahoma, "Hiragino Sans GB", "Microsoft Yahei", sans-serif;font-size:12px;color:#999999;'),e?!1:void $("body").click(function(e){0===$(e.target).closest(".nav .form").length&&$(".nav .form").hide()})},initUserChannel:function(e){var o=new ReconnectingWebSocket(e);o.reconnectInterval=1e4,o.onopen=function(){setInterval(function(){o.send("-hb-")},3e5)},o.onmessage=function(e){},o.onclose=function(){o.close()},o.onerror=function(e){console.log("ERROR",e)}},_initNav:function(){var e=location.href;$(".user-nav > a").each(function(){0===e.indexOf($(this).attr("href"))?$(this).addClass("selected"):"/register"===location.pathname?$("#aRegister").addClass("selected"):0===e.indexOf(Label.servePath+"/settings")&&$(".user-nav .nav-avatar").addClass("selected")}),$(".nav .avatar-small").parent().mouseover(function(){$(".nav .person-list").show()}).mouseout(function(){$(".nav .person-list").hide()}),$(".nav .person-list").mouseover(function(){$(".nav .person-list").show()}).mouseout(function(){$(".nav .person-list").hide()}),$(".nav-tabs a:last").offset().top>0&&$(".nav-tabs").mouseover(function(){$(".user-nav").hide()}).mouseout(function(){$(".user-nav").show()})},login:function(){if(Validate.goValidate({target:$("#loginTip"),data:[{target:$("#nameOrEmail"),type:"string",max:256,msg:Label.loginNameErrorLabel},{target:$("#loginPassword"),type:"password",msg:Label.invalidPasswordLabel}]})){var e={nameOrEmail:$("#nameOrEmail").val().replace(/(^\s*)|(\s*$)/g,""),userPassword:calcMD5($("#loginPassword").val())};$.ajax({url:Label.servePath+"/login",type:"POST",cache:!1,data:JSON.stringify(e),success:function(e,o){e.sc?("/register"===document.location.pathname?window.location.href="/":window.location.reload(),window.localStorage&&(window.localStorage.articleContent||(window.localStorage.articleContent=""),window.localStorage.commentContent||(window.localStorage.commentContent=""),window.localStorage.unreadNotificationCount||(window.localStorage.unreadNotificationCount=0))):$("#loginTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")}})}},logout:function(){window.localStorage&&(window.localStorage.clear(),window.localStorage.unreadNotificationCount=0),window.location.href=Label.servePath+"/logout?goto="+Label.servePath},startsWith:function(e,o){return e.match("^"+o)==o},uploadFile:function(e){var o="",a="",t=!1;return""===e.qiniuUploadToken?void $("#"+e.id).fileupload({multipart:!0,pasteZone:e.pasteZone,dropZone:e.pasteZone,url:Label.servePath+"/upload",paramName:"file",add:function(i,r){if(o=r.files[0].name,o||(a=r.files[0].type.split("/")[1]),window.File&&window.FileReader&&window.FileList&&window.Blob){var n=new FileReader;n.readAsArrayBuffer(r.files[0]),n.onload=function(o){var a=new Uint8Array(o.target.result.slice(0,11));return t=isImage(a),t&&o.target.result.byteLength>e.imgMaxSize?void alert("This image is too large (max "+e.imgMaxSize/1024/1024+"M)"):!t&&o.target.result.byteLength>e.fileMaxSize?void alert("This file is too large (max "+e.fileMaxSize/1024/1024+"M)"):void r.submit()}}else r.submit()},formData:function(e){var o=e.serializeArray();return o},submit:function(o,a){if(e.editor.replaceRange){var t=e.editor.getCursor();e.editor.replaceRange(e.uploadingLabel,t,t)}else $("#"+e.id+" input").prop("disabled",!0)},done:function(a,i){var r=i.result.key;if(!r)return void alert("Upload error");if(e.editor.replaceRange){var n=e.editor.getCursor();o||(o=(new Date).getTime()),t?e.editor.replaceRange("!["+o+"]("+r+") \n\n",CodeMirror.Pos(n.line,n.ch-e.uploadingLabel.length),n):e.editor.replaceRange("["+o+"]("+r+") \n\n",CodeMirror.Pos(n.line,n.ch-e.uploadingLabel.length),n)}else e.editor.$it.val(e.editor.$it.val()+"!["+o+"]("+r+") \n\n"),$("#"+e.id+" input").prop("disabled",!1)},fail:function(o,a){if(alert("Upload error: "+a.errorThrown),e.editor.replaceRange){var t=e.editor.getCursor();e.editor.replaceRange("",CodeMirror.Pos(t.line,t.ch-e.uploadingLabel.length),t)}else $("#"+e.id+" input").prop("disabled",!1)}}).on("fileuploadprocessalways",function(e,o){var a=o.files[o.index];o.files.error&&a.error&&alert(a.error)}):void $("#"+e.id).fileupload({multipart:!0,pasteZone:e.pasteZone,dropZone:e.pasteZone,url:"https://up.qbox.me/",paramName:"file",add:function(i,r){if(o=r.files[0].name,o||(a=r.files[0].type.split("/")[1]),window.File&&window.FileReader&&window.FileList&&window.Blob){var n=new FileReader;n.readAsArrayBuffer(r.files[0]),n.onload=function(o){var a=new Uint8Array(o.target.result.slice(0,11));return t=isImage(a),t&&o.target.result.byteLength>e.imgMaxSize?void alert("This image is too large (max "+e.imgMaxSize/1024/1024+"M)"):!t&&o.target.result.byteLength>e.fileMaxSize?void alert("This file is too large (max "+e.fileMaxSize/1024/1024+"M)"):void r.submit()}}else r.submit()},formData:function(t){var i=t.serializeArray();return o?(o=o.replace(/ /g,"_"),i.push({name:"key",value:"file/"+getUUID()+"/"+o})):i.push({name:"key",value:getUUID()+"."+a}),i.push({name:"token",value:e.qiniuUploadToken}),i},submit:function(o,a){if(e.editor.replaceRange){var t=e.editor.getCursor();e.editor.replaceRange(e.uploadingLabel,t,t)}else $("#"+e.id+" input").prop("disabled",!1)},done:function(a,i){var r=i.result.key;if(!r)return void alert("Upload error");if(e.editor.replaceRange){var n=e.editor.getCursor();o||(o=(new Date).getTime()),t?e.editor.replaceRange("!["+o+"]("+e.qiniuDomain+"/"+r+") \n\n",CodeMirror.Pos(n.line,n.ch-e.uploadingLabel.length),n):e.editor.replaceRange("["+o+"]("+e.qiniuDomain+"/"+r+") \n\n",CodeMirror.Pos(n.line,n.ch-e.uploadingLabel.length),n)}else e.editor.$it.val("!["+o+"]("+e.qiniuDomain+"/"+r+") \n\n"),$("#"+e.id+" input").prop("disabled",!1)},fail:function(o,a){if(alert("Upload error: "+a.errorThrown),e.editor.replaceRange){var t=e.editor.getCursor();e.editor.replaceRange("",CodeMirror.Pos(t.line,t.ch-e.uploadingLabel.length),t)}else $("#"+e.id+" input").prop("disabled",!1)}}).on("fileuploadprocessalways",function(e,o){var a=o.files[o.index];o.files.error&&a.error&&alert(a.error)})},mouseClickEffects:function(){var e=0;jQuery(document).ready(function(o){o("html").click(function(a){var t,i=18;e++,10==e?t=o("<b></b>").text("OωO"):20===e?t=o("<b></b>").text("(๑•́ ∀ •̀๑)"):30===e?t=o("<b></b>").text("(๑•́ ₃ •̀๑)"):40===e?t=o("<b></b>").text("(๑•̀_•́๑)"):50===e?t=o("<b></b>").text("（￣へ￣）"):60===e?t=o("<b></b>").text("(╯°口°)╯(┴—┴"):70===e?t=o("<b></b>").text("૮( ᵒ̌皿ᵒ̌ )ა"):80===e?t=o("<b></b>").text("╮(｡>口<｡)╭"):90===e?t=o("<b></b>").text("( ง ᵒ̌皿ᵒ̌)ง⁼³₌₃"):e>=100&&105>=e?t=o("<b></b>").text("(ꐦ°᷄д°᷅)"):(t=o("<i class='icon-heart'></i>"),
i=Math.round(14*Math.random()+6));var r=a.pageX,n=a.pageY;t.css({"z-index":9999,top:n-20,left:r,position:"absolute",color:"#E94F06","font-size":i,"-moz-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none"}),o("body").append(t),t.animate({top:n-180,opacity:0},1500,function(){t.remove()})})})}},Validate={goValidate:function(e){for(var o="<ul>",a=0;a<e.data.length;a++)Validate.validate(e.data[a])||(o+="<li>"+e.data[a].msg+"</li>");return"<ul>"===o?(e.target.html(""),e.target.removeClass("error"),!0):(e.target.html(o+"</ul>"),e.target.addClass("error"),!1)},validate:function(e){var o=!0,a="";switch(a="editor"===e.type?e.target.getValue():"imgSrc"===e.type?e.target.attr("src"):"imgStyle"===e.type?e.target.data("imageurl"):e.target.val().toString().replace(/(^\s*)|(\s*$)/g,""),e.type){case"email":/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test(e.target.val())||(o=!1);break;case"password":(0===e.target.val().length||e.target.val().length>16)&&(o=!1);break;case"confirmPassword":e.target.val()!==e.original.val()&&(o=!1);break;case"tags":var t=a.split(",");(""===a||t.length>7)&&(o=!1);for(var i=0;i<t.length;i++)if(""===t[i].replace(/(^\s*)|(\s*$)/g,"")||t[i].replace(/(^\s*)|(\s*$)/g,"").length>50){o=!1;break}break;case"url":case"imgSrc":case"imgStyle":(""===a||""!==a&&(!/^\w+:\/\//.test(a)||a.length>100))&&(o=!1);break;default:o=a.length<=e.max&&a.length>=(e.min?e.min:0)?!0:!1}return o}},Label={},pngMagic=[137,80,78,71,13,10,26,10],jpeg_jfif=[74,70,73,70],jpeg_exif=[69,120,105,102],jpegMagic=[255,216,255,224],gifMagic0=[71,73,70,56,55,97],getGifMagic1=[71,73,70,56,57,97],wavMagic1=[82,73,70,70],wavMagic2=[87,65,86,69],Audio={availabel:!1,wavFileBlob:null,recorderObj:null,init:function(){function e(e){console.log("getUserMedia->failure(): ERROR: Microphone access request failed!");var o,a="PermissionDeniedError",t="DevicesNotFoundError";switch(console.log(e),console.log(e.name),e.name){case a:o=Label.recordDeniedLabel;break;case t:o=Label.recordDeviceNotFoundLabel;break;default:o="ERROR: The following unexpected error occurred while attempting to connect to your microphone: "+e.name}console.log("getUserMedia->failure(): "+o),alert(o)}function o(e){console.log("getUserMedia->success(): Microphone access request was successful!");var o=2048,a=PredefinedRecordingModes.MONO_5_KHZ,t=a.getSampleRate(),i=a.getChannelCount();console.log("getUserMedia->success(): Detecting window audio context.");var r=new BrowserWindowAudioContextDetection;if(!r.windowAudioContextSupported()){var n="Unable to detect window audio context, cannot continue.";return console.log("getUserMedia->success(): "+n),void alert(n)}console.log("getUserMedia->success(): Window audio context supported.");var l=r.getWindowAudioContextMethod();console.log("getUserMedia->success(): Window audio context method: "+l),console.log("getUserMedia->success(): Creating recorder object."),Audio.recorderObj=new SoundRecorder(l,o,t,i),console.log("getUserMedia->success(): Initializing recorder object."),Audio.recorderObj.init(e),console.log("getUserMedia->success(): Assigning onaudioprocess event function."),Audio.recorderObj.recorder.onaudioprocess=function(e){if(Audio.recorderObj.isRecording()){var o=e.inputBuffer.getChannelData(0),a=e.inputBuffer.getChannelData(1);Audio.recorderObj.cloneChannelData(o,a),console.log("SoundRecorder.recorder.onaudioprocess: Saving audio data...")}},console.log("getUserMedia->success(): Recorder object successfully created and initialized."),console.log("getUserMedia->success(): Recorder object ready status: "+Audio.recorderObj.isReady()),Audio.availabel=!0}var a=new BrowserGetUserMediaDetection;console.log("Get user media supported: "+a.getUserMediaSupported()),a.getUserMediaSupported()?(console.log("Get user media is supported!"),console.log("Supported get user media method: "+a.getUserMediaMethod()),console.log("Assigning get user media method."),navigator.getUserMedia=a.getUserMediaMethod(),console.log("Requesting microphone access from browser."),navigator.getUserMedia({audio:!0},o,e)):(console.log("ERROR: getUserMedia not supported by browser."),alert("Your browser does not appear to support audio recording."))},handleStartRecording:function(){console.log("Starting new recording..."),Audio.recorderObj.startRecordingNewWavFile()},handleStopRecording:function(){console.log("Stopping recording."),Audio.recorderObj.stopRecording(),console.log("Building wav file."),Audio.wavFileBlob=Audio.recorderObj.buildWavFileBlob()}};