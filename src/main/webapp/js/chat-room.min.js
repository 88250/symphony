var ChatRoom={init:function(){if("mobile"!==$.ua.device.type?$(".list").height($(".side").height()-$(".chat-room .module:first").outerHeight()-20):$(".list").height($(window).height()-173),0===$("#chatContent").length)return!1;if("mobile"!==$.ua.device.type||"Apple"!==$.ua.device.vendor&&"Nokia"!==$.ua.device.vendor){Util.initCodeMirror();var e=new Editor({element:document.getElementById("chatContent"),dragDrop:!1,lineWrapping:!0,toolbar:[{name:"emoji"},{name:"bold"},{name:"italic"},{name:"quote"},{name:"link"},{name:"image",html:'<div class="tooltipped tooltipped-n" aria-label="'+Label.uploadFileLabel+'" ><form id="fileUpload" method="POST" enctype="multipart/form-data"><label class="icon-upload"><svg><use xlink:href="#upload"></use></svg><input type="file"/></label></form></div>'},{name:"unordered-list"},{name:"ordered-list"},{name:"view"},{name:"fullscreen"},{name:"question",action:"https://hacpai.com/guide/markdown"}],extraKeys:{"Alt-/":"autocompleteUserName","Cmd-/":"autocompleteEmoji","Ctrl-/":"autocompleteEmoji","Alt-S":"startAudioRecord","Alt-R":"endAudioRecord"},status:!1});e.render(),ChatRoom.editor=e.codemirror}else $("#chatContent").before('<form id="fileUpload" method="POST" enctype="multipart/form-data"><label class="btn">'+Label.uploadLabel+'<input type="file"/></label></form>').css("margin",0),ChatRoom.editor=Util.initTextarea("chatContent",function(e){window.localStorage&&(window.localStorage.chatRoom=e.$it.val())});if(window.localStorage&&window.localStorage.chatRoom&&""!==window.localStorage.chatRoom.replace(/(^\s*)|(\s*$)/g,"")&&ChatRoom.editor.setValue(window.localStorage.chatRoom),"mobile"===$.ua.device.type&&("Apple"===$.ua.device.vendor||"Nokia"===$.ua.device.vendor))return!1;ChatRoom.editor.on("changes",function(e){$("#chatContentTip").removeClass("error succ").html(""),window.localStorage&&(window.localStorage.chatRoom=e.getValue());var o=e.getCursor();if(0===e.getTokenAt(o).string.indexOf("@"))return e.showHint({hint:CodeMirror.hint.userName,completeSingle:!1}),CodeMirror.Pass}),ChatRoom.editor.on("keypress",function(e,o){o.ctrlKey&&10===o.charCode&&ChatRoom.send()}),ChatRoom.editor.on("keydown",function(e,o){if(-1<$.ua.os.name.indexOf("Mac OS")&&o.metaKey&&13===o.keyCode&&ChatRoom.send(),8===o.keyCode){var t=e.getCursor(),a=e.getTokenAt(t),i=CodeMirror.Pos(t.line,t.ch);a=e.getTokenAt(i),/^:\S+:$/.test(a.string)&&e.replaceRange("",CodeMirror.Pos(t.line,a.start),CodeMirror.Pos(t.line,a.end-1))}})},send:function(){var e={content:ChatRoom.editor.getValue()};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(e),beforeSend:function(){$(".form button.red").attr("disabled","disabled").css("opacity","0.3"),ChatRoom.editor.setOption("readOnly","nocursor")},success:function(e,o){e.sc?($("#chatContentTip").removeClass("error succ").html(""),ChatRoom.editor.setValue(""),$(".editor-preview").html(""),$(".icon-view").parent().hasClass("active")&&$(".icon-view").click(),window.localStorage&&(window.localStorage.chatRoom="")):$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")},complete:function(e,o){$(".form button.red").removeAttr("disabled").css("opacity","1"),ChatRoom.editor.setOption("readOnly",!1)}})}};