var Gobang={unitSize:30,chessLength:600,initGobang:function(a){confirm(Label.activityStartGobangTipLabel)&&($.ajax({url:Label.servePath+"/activity/gobang/start",type:"POST",cache:!1,success:function(n){0===n.code?(GobangChannel.init(a+"/gobang-game-channel?player="+Label.currentUserName),$(".side button.green").hide(),$(".side button.red, #chatInput").show()):$(".side ul").prepend("<li>"+n.msg+"</ul>")}}),$("#chatInput").keyup(function(n){if(""===$.trim($("#chatInput").val()))return!1;13===n.keyCode&&Gobang.chatSend()}))},drawChessBoard:function(){Gobang.chessCanvas.fillStyle="rgb(255,229,143)",Gobang.chessCanvas.fillRect(0,0,Gobang.chessLength,Gobang.chessLength),Gobang.chessCanvas.strokeStyle="black",Gobang.chessCanvas.lineWidth=10,Gobang.chessCanvas.strokeRect(0,0,Gobang.chessLength,Gobang.chessLength);for(var n=Gobang.chessCanvas.lineWidth=1;n<Gobang.chessLength/Gobang.unitSize;n++)Gobang.drawChessLine(n);Gobang.drawChessMan(5*Gobang.unitSize,5*Gobang.unitSize,5,"black"),Gobang.drawChessMan(15*Gobang.unitSize,5*Gobang.unitSize,5,"black"),Gobang.drawChessMan(5*Gobang.unitSize,15*Gobang.unitSize,5,"black"),Gobang.drawChessMan(15*Gobang.unitSize,15*Gobang.unitSize,5,"black")},drawChessLine:function(n){Gobang.chessCanvas.moveTo(0,n*Gobang.unitSize),Gobang.chessCanvas.lineTo(Gobang.chessLength,n*Gobang.unitSize),Gobang.chessCanvas.stroke(),Gobang.chessCanvas.moveTo(n*Gobang.unitSize,0),Gobang.chessCanvas.lineTo(n*Gobang.unitSize,Gobang.chessLength),Gobang.chessCanvas.stroke()},drawChessMan:function(n,a,e,s){Gobang.chessCanvas.fillStyle=s,Gobang.chessCanvas.beginPath(),Gobang.chessCanvas.arc(n,a,e,0,2*Math.PI,!0),Gobang.chessCanvas.fill()},getChessManPoint:function(n,a){var e=n.x,s=n.y;n.x=10*Math.floor(n.x/10),n.y=10*Math.floor(n.y/10);for(var o,t,i=n.x,g=n.x,r=n.y,b=n.y;g%30!=0;)g-=10;for(;i%30!=0;)i+=10;for(;b%30!=0;)b-=10;for(;r%30!=0;)r+=10;var l=new Array,c=new Array;if(l[0]=(i-e)*(i-e)+(r-s)*(r-s),c[l[0]]={x:i,y:r},l[1]=(i-e)*(i-e)+(b-s)*(b-s),c[l[1]]={x:i,y:b},l[2]=(g-e)*(g-e)+(r-s)*(r-s),c[l[2]]={x:g,y:r},l[3]=(g-e)*(g-e)+(b-s)*(b-s),c[l[3]]={x:g,y:b},l.sort(function(n,a){return n-a}),o=c[l[0]].x,t=c[l[0]].y,0!=o&&600!=o&&0!=t&&600!=t){var h={type:2,x:o,y:t,size:Gobang.unitSize,player:a};GobangChannel.ws.send(JSON.stringify(h))}},initCanvas:function(n,a){Gobang.chessCanvas=document.getElementById(a).getContext("2d"),Gobang.drawChessBoard()},getMousePos:function(n,a){var e=n.getBoundingClientRect();return{x:a.clientX-e.left*(n.width/e.width),y:a.clientY-e.top*(n.height/e.height)}},chatSend:function(){var n={type:1,player:$("#gobangCanvas").data("player"),message:$("#chatInput").val()};$(".side ul").prepend("<li>"+Label.currentUserName+": "+$("#chatInput").val()+"</li>"),GobangChannel.ws.send(JSON.stringify(n)),$("#chatInput").val("")},moveChess:function(n){var a=Gobang.getMousePos(document.getElementById("gobangCanvas"),n);Gobang.getChessManPoint(a,$("#gobangCanvas").data("player"))},drawChess:function(n){for(var a=1;a<n.length;a++)for(var e=1;e<n.length;e++)1==n[a][e]?Gobang.drawChessMan(a*Gobang.unitSize,e*Gobang.unitSize,Gobang.unitSize/2,"black"):2==n[a][e]&&Gobang.drawChessMan(a*Gobang.unitSize,e*Gobang.unitSize,Gobang.unitSize/2,"white")},requestDraw:function(){var n={type:7,player:$("#gobangCanvas").data("player"),drawType:"request"};GobangChannel.ws.send(JSON.stringify(n))}},GobangChannel={ws:void 0,init:function(n){GobangChannel.ws=new ReconnectingWebSocket(n),GobangChannel.ws.reconnectInterval=1e4,GobangChannel.ws.onopen=function(){},GobangChannel.ws.onmessage=function(n){var a=JSON.parse(n.data);switch(a.type){case 1:$(".side ul").prepend("<li>"+a.player+": "+a.message+"</li>");break;case 2:Gobang.drawChess(a.chess),Gobang.drawChessMan(a.posX,a.posY,5,"red"),null!=a.result&&""!=a.result&&(Util.alert(a.result),document.getElementById("gobangCanvas").removeEventListener("click",Gobang.moveChess),$(".side button.green").show(),$(".side button.red").hide(),$(".side ul").prepend("<li>GG</li>"));break;case 3:$(".side ul").prepend("<li>"+a.message+"</li>");break;case 4:$(".side ul").prepend("<li>"+a.message+"</li>"),$("#gobangCanvas").data("player",a.player);break;case 5:$(".side ul").prepend("<li>"+a.message+"</li>"),$("#gobangCanvas").data("player",a.player),Gobang.drawChess(a.chess);break;case 6:$(".side ul").prepend("<li>"+a.message+"</li>");break;case 7:var e={type:7,player:$("#gobangCanvas").data("player"),drawType:""};confirm(Label.activityAskForDrawLabel)?e.drawType="yes":e.drawType="no",GobangChannel.ws.send(JSON.stringify(e))}},GobangChannel.ws.onclose=function(){GobangChannel.ws.close()},GobangChannel.ws.onerror=function(n){console.log("ERROR",n)}}};