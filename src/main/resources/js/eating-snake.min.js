var EatingSnake={dir:null,lastDir:null,map:null,food:null,R:10,size:30,snake:null,isPause:!1,snakeCanvas:null,interval:null,currTime:200,stepTime:5,baseLen:6,startTime:null,endTime:null,countTime:null,snakeColor:0,appleColor:255,setupMap:function(){for(var a=1;a<=EatingSnake.size;a++){EatingSnake.map[a]=new Array;for(var n=1;n<=EatingSnake.size;n++)1==a||a==EatingSnake.size||1==n||n==EatingSnake.size?EatingSnake.map[a][n]=3:EatingSnake.map[a][n]=0}},initMap:function(a){EatingSnake.snakeCanvas=document.getElementById(a).getContext("2d"),EatingSnake.map=new Array,EatingSnake.setupMap(),null!=EatingSnake.snakeCanvas&&EatingSnake.snakeCanvas.clearRect(0,0,2*(EatingSnake.size-1)*EatingSnake.R,2*(EatingSnake.size-1)*EatingSnake.R);for(var n=1;n<=EatingSnake.size;n++)for(var e=1;e<=EatingSnake.size;e++)switch(EatingSnake.map[n][e]){case 0:EatingSnake.snakeCanvas.strokeStyle="gray",EatingSnake.snakeCanvas.strokeRect(2*(n-1)*EatingSnake.R,2*(e-1)*EatingSnake.R,2*EatingSnake.R,2*EatingSnake.R);break;case 1:EatingSnake.snakeCanvas.fillStyle="rgb("+EatingSnake.snakeColor+",0,0)",EatingSnake.snakeCanvas.fillRect(2*(n-1)*EatingSnake.R,2*(e-1)*EatingSnake.R,2*EatingSnake.R,2*EatingSnake.R);break;case 2:EatingSnake.snakeCanvas.fillStyle="rgb("+EatingSnake.appleColor+",0,0)",EatingSnake.snakeCanvas.fillRect(2*(n-1)*EatingSnake.R,2*(e-1)*EatingSnake.R,2*EatingSnake.R,2*EatingSnake.R);break;case 3:EatingSnake.snakeCanvas.fillStyle="gray",EatingSnake.snakeCanvas.fillRect(2*(n-1)*EatingSnake.R,2*(e-1)*EatingSnake.R,2*EatingSnake.R,2*EatingSnake.R)}},drawMap:function(){EatingSnake.snakeCanvas.clearRect(0,0,2*(EatingSnake.size-1)*EatingSnake.R,2*(EatingSnake.size-1)*EatingSnake.R);for(var a=1;a<=EatingSnake.size;a++)for(var n=1;n<=EatingSnake.size;n++)switch(EatingSnake.map[a][n]){case 0:EatingSnake.snakeCanvas.strokeStyle="gray",EatingSnake.snakeCanvas.strokeRect(2*(a-1)*EatingSnake.R,2*(n-1)*EatingSnake.R,2*EatingSnake.R,2*EatingSnake.R);break;case 1:EatingSnake.snakeCanvas.fillStyle="black",EatingSnake.snakeCanvas.fillRect(2*(a-1)*EatingSnake.R,2*(n-1)*EatingSnake.R,2*EatingSnake.R,2*EatingSnake.R);break;case 2:EatingSnake.snakeCanvas.fillStyle="red",EatingSnake.snakeCanvas.fillRect(2*(a-1)*EatingSnake.R,2*(n-1)*EatingSnake.R,2*EatingSnake.R,2*EatingSnake.R);break;case 3:EatingSnake.snakeCanvas.fillStyle="gray",EatingSnake.snakeCanvas.fillRect(2*(a-1)*EatingSnake.R,2*(n-1)*EatingSnake.R,2*EatingSnake.R,2*EatingSnake.R)}},check:function(a,n){return 0!=EatingSnake.map[a][n]},setupSnake:function(){for(var a=1;a<=5;a++)EatingSnake.snake[a]={x:a+5,y:7}},drawSnake:function(a){for(var n=1;n<EatingSnake.snake.length;n++)EatingSnake.map[EatingSnake.snake[n].x][EatingSnake.snake[n].y]=a},newFood:function(){for(;EatingSnake.food.x=Math.floor(Math.random()*(EatingSnake.size-1)+1),EatingSnake.food.y=Math.floor(Math.random()*(EatingSnake.size-1)+1),1==EatingSnake.check(EatingSnake.food.x,EatingSnake.food.y););EatingSnake.map[EatingSnake.food.x][EatingSnake.food.y]=2},gameover:function(){clearInterval(EatingSnake.interval);var a={score:EatingSnake.snake.length-EatingSnake.baseLen};$.ajax({url:Label.servePath+"/activity/eating-snake/collect",type:"POST",cache:!1,data:JSON.stringify(a),beforeSend:function(){var a=$("button.green");a.attr("disabled","disabled").css("opacity","0.3").text(a.text()+"ing")},success:function(a,n){if(0===a.code){EatingSnake.snakeCanvas.fillStyle="black",EatingSnake.snakeCanvas.fillRect(150,100,300,200),EatingSnake.snakeCanvas.clearRect(155,105,290,190),EatingSnake.snakeCanvas.font="36px serif";var e=EatingSnake.snakeCanvas.measureText("Game Over!").width;EatingSnake.snakeCanvas.fillText("Game Over!",155+(290-e)/2,150),EatingSnake.snakeCanvas.font="24px serif";var t,i=EatingSnake.snake.length-EatingSnake.baseLen;e=EatingSnake.snakeCanvas.measureText("Your Score: "+i).width,EatingSnake.snakeCanvas.fillText("Your Score: "+i,155+(290-e)/2,200),EatingSnake.snakeCanvas.fillStyle="red",EatingSnake.snakeCanvas.font="18px serif",t=i<=10?"童鞋，换键盘吧，要不行换手":10<i&&i<=20?"如此平凡的分数恕我无力吐槽":20<i&&i<=30?"哇哦，好厉害哦！":30<i&&i<=40?"哎呀我滴老天爷呀":40<i&&i<=50?"请收下我的膝盖 OTZ":"太假了！(╯‵□′)╯︵┻━┻",e=EatingSnake.snakeCanvas.measureText(t).width,EatingSnake.snakeCanvas.fillText(t,155+(290-e)/2,250)}else Util.alert(a.msg)},complete:function(){var a=$("button.green");a.removeAttr("disabled").css("opacity","1").text(a.text().substr(0,a.text().length-3))}})},eat:function(){EatingSnake.snake[EatingSnake.snake.length]={x:EatingSnake.snake[1].x,y:EatingSnake.snake[1].y},EatingSnake.newFood(),EatingSnake.snakeColor+=5,EatingSnake.appleColor-=5,clearInterval(EatingSnake.interval),25<=EatingSnake.currTime&&(EatingSnake.currTime=EatingSnake.currTime-EatingSnake.stepTime),EatingSnake.interval=setInterval(EatingSnake.gameRun,EatingSnake.currTime)},updateSnake:function(){EatingSnake.lastDir.x=EatingSnake.dir.x,EatingSnake.lastDir.y=EatingSnake.dir.y;var a=EatingSnake.snake[1].x+EatingSnake.dir.x,n=EatingSnake.snake[1].y+EatingSnake.dir.y;if(EatingSnake.check(a,n)){if(a!=EatingSnake.food.x||n!=EatingSnake.food.y)return void EatingSnake.gameover();EatingSnake.eat()}EatingSnake.drawSnake(0);for(var e=EatingSnake.snake.length-1;2<=e;e--)EatingSnake.snake[e].x=EatingSnake.snake[e-1].x,EatingSnake.snake[e].y=EatingSnake.snake[e-1].y;EatingSnake.snake[1].x=a,EatingSnake.snake[1].y=n,EatingSnake.drawSnake(1)},input:function(a){switch(a){case 65:case 37:0==EatingSnake.lastDir.x&&(EatingSnake.dir.x=-1,EatingSnake.dir.y=0);break;case 87:case 38:0==EatingSnake.lastDir.y&&(EatingSnake.dir.x=0,EatingSnake.dir.y=-1);break;case 68:case 39:0==EatingSnake.lastDir.x&&(EatingSnake.dir.x=1,EatingSnake.dir.y=0);break;case 83:case 40:0==EatingSnake.lastDir.y&&(EatingSnake.dir.x=0,EatingSnake.dir.y=1);break;case 80:EatingSnake.isPause?(EatingSnake.interval=setInterval(gameRun,currTime),EatingSnake.isPause=!1):(clearInterval(interval),EatingSnake.isPause=!0)}},init:function(){EatingSnake.dir={x:0,y:1},EatingSnake.lastDir={x:0,y:0},EatingSnake.map=new Array,EatingSnake.food={x:0,y:0},EatingSnake.currTime=200,EatingSnake.snake=new Array,EatingSnake.setupMap(),EatingSnake.setupSnake(),EatingSnake.drawSnake(1),EatingSnake.newFood(),clearInterval(EatingSnake.interval)},gameRun:function(){EatingSnake.updateSnake(),EatingSnake.drawMap()},start:function(a){window.addEventListener("keydown",function(a){if(37==a.keyCode||38==a.keyCode||39==a.keyCode||40==a.keyCode)return a.preventDefault(),!1}),$.ajax({url:Label.servePath+"/activity/eating-snake/start",type:"POST",headers:{csrfToken:a},cache:!1,success:function(a,n){if(0===a.code)return EatingSnake.init(),void(EatingSnake.interval=setInterval(EatingSnake.gameRun,EatingSnake.currTime));$("#tip").addClass("error").removeClass("succ").html("<ul><li>"+a.msg+"</li></ul>"),$("#tip").show(),setTimeout(function(){$("#tip").hide()},3e3)}})}};