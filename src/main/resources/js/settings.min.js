var Settings={report:function(e){var a=$(e);a.attr("disabled","disabled").css("opacity","0.3"),$.ajax({url:Label.servePath+"/report",type:"POST",cache:!1,data:JSON.stringify({reportDataId:$("#reportDialog").data("id"),reportDataType:2,reportType:$("input[name=report]:checked").val(),reportMemo:$("#reportTextarea").val()}),complete:function(e){a.removeAttr("disabled").css("opacity","1"),0===e.responseJSON.code?(Util.alert(Label.reportSuccLabel),$("#reportTextarea").val(""),$("#reportDialog").dialog("close")):Util.alert(e.responseJSON.msg)}})},getEmailCaptcha:function(e){$("#emailGetBtn").attr("disabled","disabled").css("opacity","0.3"),$.ajax({url:Label.servePath+"/settings/email/vc",type:"POST",headers:{csrfToken:e},data:JSON.stringify({userEmail:$("#emailInput").val(),captcha:$("#emailVerify").val()}),success:function(e){0===e.code&&($("#emailInput").prop("disabled",!0),$(".home-account__captch").hide(),$("#emailCodePanel").show(),$("#emailCode").show().focus(),$("#emailSubmitBtn").show(),$("#emailGetBtn").hide()),Util.alert(e.msg),$("#emailGetBtn").removeAttr("disabled").css("opacity","1")}})},updateEmail:function(e){$("#emailSubmitBtn").attr("disabled","disabled").css("opacity","0.3"),$.ajax({url:Label.servePath+"/settings/email",type:"POST",headers:{csrfToken:e},data:JSON.stringify({userEmail:$("#emailInput").val(),captcha:$("#emailCode").val()}),success:function(e){0===e.code?($(".home-account__captch").show(),$("#emailVerify").val(""),$("#emailCodePanel").hide(),$("#emailCode").val(""),$("#emailSubmitBtn").hide(),$("#emailGetBtn").show(),$("#emailInput").prop("disabled",!1),$(".home-account__captch img").click(),Util.alert(Label.updateSuccLabel)):(1===e.code&&($(".home-account__captch").show(),$("#emailVerify").val(""),$("#emailCodePanel").hide(),$("#emailCodePanel").hide(),$("#emailSubmitBtn").hide(),$("#emailGetBtn").show(),$("#emailInput").prop("disabled",!1),$(".home-account__captch img").click()),Util.alert(e.msg)),$("#emailSubmitBtn").removeAttr("disabled").css("opacity","1")}})},homeScroll:function(){$(".nav-tabs").html($(".home-menu").html()),$(".nav").css({position:"fixed","box-shadow":"0 1px 2px rgba(0,0,0,.2)"}),$(".main").css("paddingTop","68px")},notiScroll:function(){var e=$("#side"),a=e.width(),t=1===$(".small-tips").closest(".module").length?109+$(".small-tips").closest(".module").height():89;$(".side.fn-none").height(e.height()),$(window).scroll(function(){$(window).scrollTop()>t?(e.css({position:"fixed",width:a+"px",top:0,right:$(".wrapper").css("margin-right")}),$(".side.fn-none").show(),$(".small-tips").closest(".module").hide()):(e.removeAttr("style"),$(".side.fn-none").hide(),$(".small-tips").closest(".module").show())})},initUploadAvatar:function(e,r){$("#"+e.id).fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:parseInt(e.maxSize),multipart:!0,pasteZone:null,dropZone:null,url:Label.servePath+"/upload",paramName:"file[]",add:function(e,t){if(t.files[0].type.split("/")[1],window.File&&window.FileReader&&window.FileList&&window.Blob){var a=new FileReader;a.readAsArrayBuffer(t.files[0]),a.onload=function(e){var a=new Uint8Array(e.target.result.slice(0,11));isImage(a)?1048576<e.target.result.byteLength?Util.alert("This image is too large (max 1M)"):t.submit():Util.alert("Image only~")}}else t.submit()},formData:function(e){return e.serializeArray()},submit:function(e,a){},done:function(e,a){var t={result:{key:a.result.data.succMap[Object.keys(a.result.data.succMap)[0]]}};r(t)},fail:function(e,a){Util.alert("Upload error: "+a.errorThrown)}}).on("fileuploadprocessalways",function(e,a){var t=a.files[a.index];a.files.error&&t.error&&Util.alert(t.error)})},exportPosts:function(){$.ajax({url:Label.servePath+"/export/posts",type:"POST",cache:!1,success:function(e,a){0===e.code?window.open(e.url):Util.alert("TBD: V, tip display it....")}})},changeGeoStatus:function(e){var a={userGeoStatus:$("#geoStatus").val()};$.ajax({url:Label.servePath+"/settings/geo/status",type:"POST",headers:{csrfToken:e},cache:!1,data:JSON.stringify(a),success:function(e,a){console.log(e)}})},pointTransfer:function(e){if(Validate.goValidate({target:$("#pointTransferTip"),data:[{target:$("#pointTransferUserName"),type:"string",max:256,msg:Label.invalidUserNameLabel},{target:$("#pointTransferAmount"),type:"string",max:50,msg:Label.amountNotEmpty}]})){var a={userName:$("#pointTransferUserName").val(),amount:$("#pointTransferAmount").val(),memo:$("#pointTransferMemo").val()};$.ajax({url:Label.servePath+"/point/transfer",type:"POST",headers:{csrfToken:e},cache:!1,data:JSON.stringify(a),beforeSend:function(){$("#pointTransferTip").removeClass("succ").removeClass("error").html("")},error:function(e,a,t){Util.alert(t)},success:function(e,a){0===e.code?($("#pointTransferTip").addClass("succ").removeClass("error").html("<ul><li>"+Label.transferSuccLabel+"</li></ul>"),$("#pointTransferUserName").val(""),$("#pointTransferAmount").val(""),$("#pointTransferMemo").val("")):$("#pointTransferTip").addClass("error").removeClass("succ").html("<ul><li>"+e.msg+"</li></ul>"),$("#pointTransferTip").show(),setTimeout(function(){$("#pointTransferTip").hide()},2e3)}})}},pointBuyInvitecode:function(e){$.ajax({url:Label.servePath+"/point/buy-invitecode",type:"POST",headers:{csrfToken:e},cache:!1,data:JSON.stringify({}),beforeSend:function(){$("#pointBuyInvitecodeTip").removeClass("succ").removeClass("error").html("")},error:function(e,a,t){Util.alert(t)},success:function(e,a){0===e.code?$(".list ul").prepend('<li class="vditor-reset"><code>'+e.msg.split(" ")[0]+"</code>"+e.msg.substr(16)+"</li>"):$("#pointBuyInvitecodeTip").addClass("error").removeClass("succ").html("<ul><li>"+e.msg+"</li></ul>"),$("#pointBuyInvitecodeTip").show()}})},queryInvitecode:function(e){var a={invitecode:$("#invitecode").val()};$.ajax({url:Label.servePath+"/invitecode/state",type:"POST",headers:{csrfToken:e},cache:!1,data:JSON.stringify(a),beforeSend:function(){$("#invitecodeStateTip").removeClass("succ").removeClass("error").html("")},error:function(e,a,t){Util.alert(t)},success:function(e,a){switch(e.code){case-1:case 0:case 2:$("#invitecodeStateTip").addClass("error").removeClass("succ").html("<ul><li>"+e.msg+"</li></ul>");break;case 1:$("#invitecodeStateTip").addClass("succ").removeClass("error").html("<ul><li>"+e.msg+"</li></ul>");break;default:$("#invitecodeStateTip").addClass("error").removeClass("succ").html("<ul><li>"+e.msg+"</li></ul>")}S,$("#invitecodeStateTip").show()}})},update:function(t,e){var r={};switch(t){case"profiles":r=this._validateProfiles();break;case"password":r=this._validatePassword();break;case"privacy":r={userArticleStatus:$("#userArticleStatus").prop("checked"),userCommentStatus:$("#userCommentStatus").prop("checked"),userFollowingUserStatus:$("#userFollowingUserStatus").prop("checked"),userFollowingTagStatus:$("#userFollowingTagStatus").prop("checked"),userFollowingArticleStatus:$("#userFollowingArticleStatus").prop("checked"),userWatchingArticleStatus:$("#userWatchingArticleStatus").prop("checked"),userFollowerStatus:$("#userFollowerStatus").prop("checked"),userBreezemoonStatus:$("#userBreezemoonStatus").prop("checked"),userPointStatus:$("#userPointStatus").prop("checked"),userOnlineStatus:$("#userOnlineStatus").prop("checked"),userJoinPointRank:$("#joinPointRank").prop("checked"),userJoinUsedPointRank:$("#joinUsedPointRank").prop("checked"),userUAStatus:$("#userUAStatus").prop("checked")};break;case"function":r={userListPageSize:$("#userListPageSize").val(),userIndexRedirectURL:$("#userIndexRedirectURL").val(),userCommentViewMode:$("#userCommentViewMode").val(),userAvatarViewMode:$("#userAvatarViewMode").val(),userListViewMode:$("#userListViewMode").val(),userNotifyStatus:$("#userNotifyStatus").prop("checked"),userSubMailStatus:$("#userSubMailStatus").prop("checked"),userKeyboardShortcutsStatus:$("#userKeyboardShortcutsStatus").prop("checked"),userReplyWatchArticleStatus:$("#userReplyWatchArticleStatus").prop("checked"),userForwardPageStatus:$("#userForwardPageStatus").prop("checked")};break;case"emotionList":r=this._validateEmotionList();break;case"i18n":r={userLanguage:$("#userLanguage").val(),userTimezone:$("#userTimezone").val()};break;case"username":r={userName:$("#newUsername").val()};break;case"deactivate":break;default:console.log("update settings has no type")}if(!r)return!1;$.ajax({url:Label.servePath+"/settings/"+t,type:"POST",headers:{csrfToken:e},cache:!1,data:JSON.stringify(r),beforeSend:function(){$("#"+t.replace(/\//g,"")+"Tip").removeClass("succ").removeClass("error").html("")},error:function(e,a,t){Util.alert(t)},success:function(e,a){if(0===e.code){if($("#"+t.replace(/\//g,"")+"Tip").addClass("succ").removeClass("error").html("<ul><li>"+Label.updateSuccLabel+"</li></ul>").show(),"profiles"===t)return $("#userNicknameDom").text(r.userNickname),$("#userTagsDom").text(r.userTags),$("#userURLDom").text(r.userURL).attr("href",r.userURL),void $("#userIntroDom").text(r.userIntro)}else $("#"+t.replace(/\//g,"")+"Tip").addClass("error").removeClass("succ").html("<ul><li>"+e.msg+"</li></ul>");$("#"+t.replace(/\//g,"")+"Tip").show(),setTimeout(function(){$("#"+t.replace(/\//g,"")+"Tip").hide(),"i18n"===t&&window.location.reload(),"deactivate"===t&&(window.location.href=Label.servePath)},5e3)}})},updateAvatar:function(e){var t={userAvatarURL:$("#avatarURL").data("imageurl")};$.ajax({url:Label.servePath+"/settings/avatar",type:"POST",headers:{csrfToken:e},cache:!1,data:JSON.stringify(t),beforeSend:function(){},error:function(e,a,t){Util.alert(t)},success:function(e,a){0===e.code&&$("#avatarURLDom, .user-nav .avatar-small").attr("style","background-image:url("+t.userAvatarURL+")")}})},_validateProfiles:function(){return!!Validate.goValidate({target:$("#profilesTip"),data:[{target:$("#userNickname"),type:"string",min:0,max:20,msg:Label.invalidUserNicknameLabel},{target:$("#userTags"),type:"string",min:0,max:255,msg:Label.tagsErrorLabel},{target:$("#userURL"),type:"string",min:0,max:255,msg:Label.invalidUserURLLabel},{target:$("#userIntro"),type:"string",min:0,max:255,msg:Label.invalidUserIntroLabel}]})&&{userNickname:$("#userNickname").val().replace(/(^\s*)|(\s*$)/g,""),userTags:$("#userTags").val().replace(/(^\s*)|(\s*$)/g,""),userURL:$("#userURL").val().replace(/(^\s*)|(\s*$)/g,""),userIntro:$("#userIntro").val().replace(/(^\s*)|(\s*$)/g,"")}},_validatePassword:function(){var e=$("#pwdOld").val(),a=$("#pwdNew").val();if(Validate.goValidate({target:$("#passwordTip"),data:[{target:$("#pwdNew"),type:"password",msg:Label.invalidPasswordLabel},{target:$("#pwdRepeat"),type:"password",oranginal:$("#pwdNew"),msg:Label.confirmPwdErrorLabel}]})){if(a!==$("#pwdRepeat").val())return!1;var t={};return t.userPassword=calcMD5(e),t.userNewPassword=calcMD5(a),t}return!1},_validateEmotionList:function(){return{emotions:$("#emotionList").val()}},makeAllNotificationsRead:function(){$.ajax({url:Label.servePath+"/notifications/all-read",type:"GET",cache:!1,success:function(e,a){0===e.code&&window.location.reload()}})},removeNotifications:function(e){return $.ajax({url:Label.servePath+"/notifications/remove/"+e,type:"GET",cache:!1,success:function(e){0===e.code&&location.reload()}}),!1},initFunction:function(){$("#emojiGrid img").click(function(){var e=$(this).attr("alt");-1===$("#emotionList").val().indexOf(e)&&(""!==$("#emotionList").val()?$("#emotionList").val($("#emotionList").val()+","+e):$("#emotionList").val(e))})},initHome:function(){"commentsAnonymous"!==Label.type&&"comments"!==Label.type||(Util.parseHljs(),Util.parseMarkdown()),$("#reportDialog").dialog({width:500<$(window).width()?500:$(window).width()-50,height:365,modal:!0,hideFooter:!0}),"mobile"!==$.ua.device.type&&(Settings.homeScroll(),$.pjax({selector:"a",container:"#home-pjax-container",show:"",cache:!1,storage:!0,titleSuffix:"",filter:function(e){return e.indexOf(Label.servePath+"/member/"+Label.userName)<0},callback:function(e){switch(e.type){case"success":case"cache":switch($(".home-menu a").removeClass("current"),location.pathname){case"/member/"+Label.userName:case"/member/"+Label.userName+"/comments":Util.parseHljs(),Util.parseMarkdown();case"/member/"+Label.userName+"/articles/anonymous":case"/member/"+Label.userName+"/comments/anonymous":Util.parseHljs(),Util.parseMarkdown(),$(".home-menu a:eq(0)").addClass("current");break;case"/member/"+Label.userName+"/watching/articles":case"/member/"+Label.userName+"/following/users":case"/member/"+Label.userName+"/following/tags":case"/member/"+Label.userName+"/following/articles":case"/member/"+Label.userName+"/followers":$(".home-menu a:eq(1)").addClass("current");break;case"/member/"+Label.userName+"/breezemoons":$(".home-menu a:eq(1)").addClass("current"),Breezemoon.init();break;case"/member/"+Label.userName+"/points":$(".home-menu a:eq(2)").addClass("current")}}$(".nav-tabs").html($(".home-menu").html()),Util.parseMarkdown(),Util.parseHljs()}}),NProgress.configure({showSpinner:!1}),$("#home-pjax-container").bind("pjax.start",function(){NProgress.start()}),$("#home-pjax-container").bind("pjax.end",function(){NProgress.done()}))}};